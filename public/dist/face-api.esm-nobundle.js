var lr=Object.defineProperty,bo=Object.getOwnPropertyDescriptor,go=Object.getOwnPropertyNames,xo=Object.prototype.hasOwnProperty,vo=(e=>"undefined"!=typeof require?require:"undefined"!=typeof Proxy?new Proxy(e,{get:(e,t)=>("undefined"!=typeof require?require:e)[t]}):e)((function(e){if("undefined"!=typeof require)return require.apply(this,arguments);throw new Error('Dynamic require of "'+e+'" is not supported')})),Ve=(e,t)=>{for(var n in t)lr(e,n,{get:t[n],enumerable:!0})},fr=(e,t,n,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let a of go(t))!xo.call(e,a)&&a!==n&&lr(e,a,{get:()=>t[a],enumerable:!(r=bo(t,a))||r.enumerable});return e},P=(e,t,n)=>(fr(e,t,"default"),n&&fr(n,t,"default")),n={};Ve(n,{version:()=>Po}),P(n,mn),P(n,pn),P(n,un);import*as mn from"@tensorflow/tfjs/dist/index.js";import*as pn from"@tensorflow/tfjs-backend-webgl/dist/index.js";import*as un from"@tensorflow/tfjs-backend-wasm/dist/index.js";var dr="4.1.0",yo="4.1.0",_o="4.1.0",To="4.1.0",wo="4.1.0",Po={tfjs:dr,"tfjs-core":dr,"tfjs-converter":yo,"tfjs-backend-cpu":_o,"tfjs-backend-webgl":To,"tfjs-backend-wasm":wo},Wr={};function Z(e,t,n=!1){if(e.beginPath(),t.slice(1).forEach((({x:n,y:r},a)=>{let i=t[a];e.moveTo(i.x,i.y),e.lineTo(n,r)})),n){let n=t[t.length-1],r=t[0];if(!n||!r)return;e.moveTo(n.x,n.y),e.lineTo(r.x,r.y)}e.stroke()}Ve(Wr,{AnchorPosition:()=>Ke,DrawBox:()=>ee,DrawBoxOptions:()=>de,DrawFaceLandmarks:()=>De,DrawFaceLandmarksOptions:()=>Fe,DrawTextField:()=>et,DrawTextFieldOptions:()=>kt,drawContour:()=>Z,drawDetections:()=>No,drawFaceExpressions:()=>So,drawFaceLandmarks:()=>Ao});var hr={};Ve(hr,{computeReshapedDimensions:()=>je,getCenterPoint:()=>yt,isDimensions:()=>ue,isEven:()=>pe,isFloat:()=>Ge,isTensor:()=>xt,isTensor1D:()=>Fo,isTensor2D:()=>Ye,isTensor3D:()=>K,isTensor4D:()=>R,isValidNumber:()=>G,isValidProbablitiy:()=>It,range:()=>U,round:()=>vt});var S=class{constructor(e,t){if(!G(e)||!G(t))throw new Error(`Dimensions.constructor - expected width and height to be valid numbers, instead have ${JSON.stringify({width:e,height:t})}`);this._width=e,this._height=t}get width(){return this._width}get height(){return this._height}reverse(){return new S(1/this.width,1/this.height)}};function xt(e,t){return e instanceof n.Tensor&&e.shape.length===t}function Fo(e){return xt(e,1)}function Ye(e){return xt(e,2)}function K(e){return xt(e,3)}function R(e){return xt(e,4)}function Ge(e){return e%1!=0}function pe(e){return e%2==0}function vt(e,t=2){let n=10**t;return Math.floor(e*n)/n}function ue(e){return e&&e.width&&e.height}function je({width:e,height:t},n){let r=n/Math.max(t,e);return new S(Math.round(e*r),Math.round(t*r))}function yt(e){return e.reduce(((e,t)=>e.add(t)),new g(0,0)).div(new g(e.length,e.length))}function U(e,t,n){return Array(e).fill(0).map(((e,r)=>t+r*n))}function G(e){return!!e&&e!==1/0&&e!==-1/0&&!Number.isNaN(e)||0===e}function It(e){return G(e)&&e>=0&&e<=1}var g=class{constructor(e,t){this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}add(e){return new g(this.x+e.x,this.y+e.y)}sub(e){return new g(this.x-e.x,this.y-e.y)}mul(e){return new g(this.x*e.x,this.y*e.y)}div(e){return new g(this.x/e.x,this.y/e.y)}abs(){return new g(Math.abs(this.x),Math.abs(this.y))}magnitude(){return Math.sqrt(this.x**2+this.y**2)}floor(){return new g(Math.floor(this.x),Math.floor(this.y))}},F=class{static isRect(e){return!!e&&[e.x,e.y,e.width,e.height].every(G)}static assertIsValidBox(e,t,n=!1){if(!F.isRect(e))throw new Error(`${t} - invalid box: ${JSON.stringify(e)}, expected object with properties x, y, width, height`);if(!n&&(e.width<0||e.height<0))throw new Error(`${t} - width (${e.width}) and height (${e.height}) must be positive numbers`)}constructor(e,t=!0){let n=e||{},r=[n.left,n.top,n.right,n.bottom].every(G),a=[n.x,n.y,n.width,n.height].every(G);if(!a&&!r)throw new Error(`Box.constructor - expected box to be IBoundingBox | IRect, instead have ${JSON.stringify(n)}`);let[i,o,s,c]=a?[n.x,n.y,n.width,n.height]:[n.left,n.top,n.right-n.left,n.bottom-n.top];F.assertIsValidBox({x:i,y:o,width:s,height:c},"Box.constructor",t),this._x=i,this._y=o,this._width=s,this._height=c}get x(){return this._x}get y(){return this._y}get width(){return this._width}get height(){return this._height}get left(){return this.x}get top(){return this.y}get right(){return this.x+this.width}get bottom(){return this.y+this.height}get area(){return this.width*this.height}get topLeft(){return new g(this.left,this.top)}get topRight(){return new g(this.right,this.top)}get bottomLeft(){return new g(this.left,this.bottom)}get bottomRight(){return new g(this.right,this.bottom)}round(){let[e,t,n,r]=[this.x,this.y,this.width,this.height].map((e=>Math.round(e)));return new F({x:e,y:t,width:n,height:r})}floor(){let[e,t,n,r]=[this.x,this.y,this.width,this.height].map((e=>Math.floor(e)));return new F({x:e,y:t,width:n,height:r})}toSquare(){let{x:e,y:t,width:n,height:r}=this,a=Math.abs(n-r);return n<r&&(e-=a/2,n+=a),r<n&&(t-=a/2,r+=a),new F({x:e,y:t,width:n,height:r})}rescale(e){let t=ue(e)?e.width:e,n=ue(e)?e.height:e;return new F({x:this.x*t,y:this.y*n,width:this.width*t,height:this.height*n})}pad(e,t){let[n,r,a,i]=[this.x-e/2,this.y-t/2,this.width+e,this.height+t];return new F({x:n,y:r,width:a,height:i})}clipAtImageBorders(e,t){let{x:n,y:r,right:a,bottom:i}=this,o=Math.max(n,0),s=Math.max(r,0),c=a-o,h=i-s,l=Math.min(c,e-o),d=Math.min(h,t-s);return new F({x:o,y:s,width:l,height:d}).floor()}shift(e,t){let{width:n,height:r}=this,a=this.x+e,i=this.y+t;return new F({x:a,y:i,width:n,height:r})}padAtBorders(e,t){let n=this.width+1,r=this.height+1,a=n,i=r,o=this.left,s=this.top,c=this.right,h=this.bottom;return c>t&&(a=-c+t+n,c=t),h>e&&(i=-h+e+r,h=e),o<1&&(i=2-o,o=1),s<1&&(i=2-s,s=1),{dy:1,edy:i,dx:1,edx:a,y:s,ey:h,x:o,ex:c,w:n,h:r}}calibrate(e){return new F({left:this.left+e.left*this.width,top:this.top+e.top*this.height,right:this.right+e.right*this.width,bottom:this.bottom+e.bottom*this.height}).toSquare().round()}},Nt=class extends F{constructor(e,t,n,r,a=!1){super({left:e,top:t,right:n,bottom:r},a)}},ct=class{constructor(e,t,n,r,a){this._imageDims=new S(a.width,a.height),this._score=e,this._classScore=t,this._className=n,this._box=new F(r).rescale(this._imageDims)}get score(){return this._score}get classScore(){return this._classScore}get className(){return this._className}get box(){return this._box}get imageDims(){return this._imageDims}get imageWidth(){return this.imageDims.width}get imageHeight(){return this.imageDims.height}get relativeBox(){return new F(this._box).rescale(this.imageDims.reverse())}forSize(e,t){return new ct(this.score,this.classScore,this.className,this.relativeBox,{width:e,height:t})}},E=class extends ct{constructor(e,t,n){super(e,e,"",t,n)}forSize(e,t){let{score:n,relativeBox:r,imageDims:a}=super.forSize(e,t);return new E(n,r,a)}};function br(e,t,n=!0){let r=Math.max(0,Math.min(e.right,t.right)-Math.max(e.left,t.left))*Math.max(0,Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top));return n?r/(e.area+t.area-r):r/Math.min(e.area,t.area)}function gr(e){let t=e.map((e=>e.x)),n=e.map((e=>e.y)),r=t.reduce(((e,t)=>t<e?t:e),1/0),a=n.reduce(((e,t)=>t<e?t:e),1/0),i=t.reduce(((e,t)=>e<t?t:e),0),o=n.reduce(((e,t)=>e<t?t:e),0);return new Nt(r,a,i,o)}function xr(e,t,n,r=!0){let a=t.map(((e,t)=>({score:e,boxIndex:t}))).sort(((e,t)=>e.score-t.score)).map((e=>e.boxIndex)),i=[];for(;a.length>0;){let t=a.pop();i.push(t);let o=a,s=[];for(let n=0;n<o.length;n++){let a=o[n],i=e[t],c=e[a];s.push(br(i,c,r))}a=a.filter(((e,t)=>s[t]<=n))}return i}function X(e,t){return n.tidy((()=>{let[r,a,i]=t,o=n.fill([...e.shape.slice(0,3),1],r,"float32"),s=n.fill([...e.shape.slice(0,3),1],a,"float32"),c=n.fill([...e.shape.slice(0,3),1],i,"float32"),h=n.concat([o,s,c],3);return n.sub(e,h)}))}function vr(e,t=!1){return n.tidy((()=>{let[r,a]=e.shape.slice(1);if(r===a)return e;let i=Math.abs(r-a),o=Math.round(i*(t?.5:1)),s=r>a?2:1,c=t=>{let r=e.shape.slice();return r[s]=t,n.fill(r,0,"float32")},h=c(o),l=i-h.shape[s],d=[t&&l?c(l):null,e,h].filter((e=>!!e)).map((e=>n.cast(e,"float32")));return n.concat(d,s)}))}function Rn(e){let t=e.slice();for(let e=t.length-1;e>0;e--){let n=Math.floor(Math.random()*(e+1)),r=t[e];t[e]=t[n],t[n]=r}return t}function fe(e){return 1/(1+Math.exp(-e))}function On(e){return Math.log(e/(1-e))}var C,St=class extends F{constructor(e,t,n,r,a=!1){super({x:e,y:t,width:n,height:r},a)}},Do=.5,Eo=.43,Mo=.45,$=class{constructor(e,t,n=new g(0,0)){let{width:r,height:a}=t;this._imgDims=new S(r,a),this._shift=n,this._positions=e.map((e=>e.mul(new g(r,a)).add(n)))}get shift(){return new g(this._shift.x,this._shift.y)}get imageWidth(){return this._imgDims.width}get imageHeight(){return this._imgDims.height}get positions(){return this._positions}get relativePositions(){return this._positions.map((e=>e.sub(this._shift).div(new g(this.imageWidth,this.imageHeight))))}forSize(e,t){return new this.constructor(this.relativePositions,{width:e,height:t})}shiftBy(e,t){return new this.constructor(this.relativePositions,this._imgDims,new g(e,t))}shiftByPoint(e){return this.shiftBy(e.x,e.y)}align(e,t={}){if(e){let n=e instanceof E?e.box.floor():new F(e);return this.shiftBy(n.x,n.y).align(null,t)}let{useDlibAlignment:n,minBoxPadding:r}={useDlibAlignment:!1,minBoxPadding:.2,...t};return n?this.alignDlib():this.alignMinBbox(r)}alignDlib(){let e=this.getRefPointsForAlignment(),[t,n,r]=e,a=e=>r.sub(e).magnitude(),i=(a(t)+a(n))/2,o=Math.floor(i/Mo),s=yt(e),c=Math.floor(Math.max(0,s.x-Do*o)),h=Math.floor(Math.max(0,s.y-Eo*o));return new St(c,h,Math.min(o,this.imageWidth+c),Math.min(o,this.imageHeight+h))}alignMinBbox(e){let t=gr(this.positions);return t.pad(t.width*e,t.height*e)}getRefPointsForAlignment(){throw new Error("getRefPointsForAlignment not implemented by base class")}},yr=class extends ${getRefPointsForAlignment(){let e=this.positions;return[e[0],e[1],yt([e[3],e[4]])]}},Lt=class extends ${getJawOutline(){return this.positions.slice(0,17)}getLeftEyeBrow(){return this.positions.slice(17,22)}getRightEyeBrow(){return this.positions.slice(22,27)}getNose(){return this.positions.slice(27,36)}getLeftEye(){return this.positions.slice(36,42)}getRightEye(){return this.positions.slice(42,48)}getMouth(){return this.positions.slice(48,68)}getRefPointsForAlignment(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(yt)}},Kt=class{constructor(e,t){this._label=e,this._distance=t}get label(){return this._label}get distance(){return this._distance}toString(e=!0){return`${this.label}${e?` (${vt(this.distance)})`:""}`}},Qt=class extends F{constructor(e,t){super(e),this._label=t}static assertIsValidLabeledBox(e,t){if(F.assertIsValidBox(e,t),!G(e.label))throw new Error(`${t} - expected property label (${e.label}) to be a number`)}get label(){return this._label}},Q=class{constructor(e,t){if("string"!=typeof e)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(t)||t.some((e=>!(e instanceof Float32Array))))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=e,this._descriptors=t}get label(){return this._label}get descriptors(){return this._descriptors}toJSON(){return{label:this.label,descriptors:this.descriptors.map((e=>Array.from(e)))}}static fromJSON(e){let t=e.descriptors.map((e=>new Float32Array(e)));return new Q(e.label,t)}},_r=class extends Qt{constructor(e,t,n,r){super(e,t),this._score=n,this._classScore=r}static assertIsValidPredictedBox(e,t){if(Qt.assertIsValidLabeledBox(e,t),!It(e.score)||!It(e.classScore))throw new Error(`${t} - expected properties score (${e.score}) and (${e.classScore}) to be a number between [0, 1]`)}get score(){return this._score}get classScore(){return this._classScore}};function tt(e){return e.detection instanceof E}function At(e,t){return{...e,detection:t}}function Ue(){let e=window.fetch;if(!e)throw new Error("fetch - missing fetch implementation for browser environment");return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:()=>document.createElement("canvas"),createImageElement:()=>document.createElement("img"),createVideoElement:()=>document.createElement("video"),fetch:e,readFile:()=>{throw new Error("readFile - filesystem not available for browser environment")}}}function te(){return"object"==typeof global&&"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node}function le(e){let t="";if(!e&&te())try{e=vo("fs")}catch(e){t=e.toString()}return{readFile:e?t=>new Promise(((n,r)=>{e.readFile(t,((e,t)=>e?r(e):n(t)))})):()=>{throw new Error(`readFile - failed to require fs in nodejs environment with error: ${t}`)}}}function Xe(){let e=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,n=global.Video||global.HTMLVideoElement,r=global.fetch,a=le();return{Canvas:e||class{},CanvasRenderingContext2D:global.CanvasRenderingContext2D||class{},Image:t||class{},ImageData:global.ImageData||class{},Video:global.HTMLVideoElement||class{},createCanvasElement:()=>{if(e)return new e;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:()=>{if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},createVideoElement:()=>{if(n)return new n;throw new Error("createVideoElement - missing Video implementation for nodejs environment")},fetch:r,...a}}function Je(){return"object"==typeof window&&"undefined"!=typeof document&&"undefined"!=typeof HTMLImageElement&&"undefined"!=typeof HTMLCanvasElement&&"undefined"!=typeof HTMLVideoElement&&"undefined"!=typeof ImageData&&"undefined"!=typeof CanvasRenderingContext2D}function Co(){if(!C)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return C}function qe(e){C=e}function Ze(){return Je()?qe(Ue()):te()?qe(Xe()):null}function Io(e){if(C||Ze(),!C)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");let{Canvas:t=C.Canvas,Image:n=C.Image}=e;C.Canvas=t,C.Image=n,C.createCanvasElement=e.createCanvasElement||(()=>new t),C.createImageElement=e.createImageElement||(()=>new n),C.ImageData=e.ImageData||C.ImageData,C.Video=e.Video||C.Video,C.fetch=e.fetch||C.fetch,C.readFile=e.readFile||C.readFile}var _={getEnv:Co,setEnv:qe,initialize:Ze,createBrowserEnv:Ue,createFileSystem:le,createNodejsEnv:Xe,monkeyPatch:Io,isBrowser:Je,isNodejs:te};function Wt(e){return _.isNodejs()||"string"!=typeof e?e:document.getElementById(e)}function k(e){let{Canvas:t,CanvasRenderingContext2D:n}=_.getEnv();if(e instanceof n)return e;let r=Wt(e);if(!(r instanceof t))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");let a=r.getContext("2d");if(!a)throw new Error("resolveContext2d - canvas 2d context is null");return a}Ze();var Ke=(e=>(e.TOP_LEFT="TOP_LEFT",e.TOP_RIGHT="TOP_RIGHT",e.BOTTOM_LEFT="BOTTOM_LEFT",e.BOTTOM_RIGHT="BOTTOM_RIGHT",e))(Ke||{}),kt=class{constructor(e={}){let{anchorPosition:t,backgroundColor:n,fontColor:r,fontSize:a,fontStyle:i,padding:o}=e;this.anchorPosition=t||"TOP_LEFT",this.backgroundColor=n||"rgba(0, 0, 0, 0.5)",this.fontColor=r||"rgba(255, 255, 255, 1)",this.fontSize=a||14,this.fontStyle=i||"Georgia",this.padding=o||4}},et=class{constructor(e,t,n={}){this.text="string"==typeof e?[e]:e instanceof et?e.text:e,this.anchor=t,this.options=new kt(n)}measureWidth(e){let{padding:t}=this.options;return this.text.map((t=>e.measureText(t).width)).reduce(((e,t)=>e<t?t:e),0)+2*t}measureHeight(){let{fontSize:e,padding:t}=this.options;return this.text.length*e+2*t}getUpperLeft(e,t){let{anchorPosition:n}=this.options,r="BOTTOM_RIGHT"===n||"TOP_RIGHT"===n,a="BOTTOM_LEFT"===n||"BOTTOM_RIGHT"===n,i=this.measureWidth(e),o=this.measureHeight(),s=r?this.anchor.x-i:this.anchor.x,c=a?this.anchor.y-o:this.anchor.y;if(t){let{width:e,height:n}=t;return{x:Math.max(Math.min(s,e-i),0),y:Math.max(Math.min(c,n-o),0)}}return{x:s,y:c}}draw(e){let t=Wt(e),n=k(t),{backgroundColor:r,fontColor:a,fontSize:i,fontStyle:o,padding:s}=this.options;n.font=`${i}px ${o}`;let c=this.measureWidth(n),h=this.measureHeight();n.fillStyle=r;let l=this.getUpperLeft(n,t);n.fillRect(l.x,l.y,c,h),n.fillStyle=a,this.text.forEach(((e,t)=>{let r=s+l.x,a=s+l.y+(t+1)*i;n.fillText(e,r,a)}))}},de=class{constructor(e={}){let{boxColor:t,lineWidth:n,label:r,drawLabelOptions:a}=e;this.boxColor=t||"rgba(0, 0, 255, 1)",this.lineWidth=n||2,this.label=r;let i={anchorPosition:"BOTTOM_LEFT",backgroundColor:this.boxColor};this.drawLabelOptions=new kt({...i,...a})}},ee=class{constructor(e,t={}){this.box=new F(e),this.options=new de(t)}draw(e){let t=k(e),{boxColor:n,lineWidth:r}=this.options,{x:a,y:i,width:o,height:s}=this.box;t.strokeStyle=n,t.lineWidth=r,t.strokeRect(a,i,o,s);let{label:c}=this.options;c&&new et([c],{x:a-r/2,y:i},this.options.drawLabelOptions).draw(e)}};function No(e,t){(Array.isArray(t)?t:[t]).forEach((t=>{let n=t instanceof E?t.score:tt(t)?t.detection.score:void 0,r=t instanceof E?t.box:tt(t)?t.detection.box:new F(t),a=n?`${vt(n)}`:void 0;new ee(r,{label:a}).draw(e)}))}function he(e){let{Image:t,Video:n}=_.getEnv();return e instanceof t&&e.complete||e instanceof n&&e.readyState>=3}function Tr(e){return new Promise(((t,n)=>{function r(e){!e.currentTarget||(e.currentTarget.removeEventListener("load",a),e.currentTarget.removeEventListener("error",r),n(e))}function a(e){!e.currentTarget||(e.currentTarget.removeEventListener("load",a),e.currentTarget.removeEventListener("error",r),t(e))}(e instanceof _.getEnv().Canvas||he(e))&&t(null),e.addEventListener("load",a),e.addEventListener("error",r)}))}function wr(e){return new Promise(((t,n)=>{e instanceof Blob||n(new Error("bufferToImage - expected buf to be of type: Blob"));let r=new FileReader;r.onload=()=>{"string"!=typeof r.result&&n(new Error("bufferToImage - expected reader.result to be a string, in onload"));let e=_.getEnv().createImageElement();e.onload=()=>t(e),e.onerror=n,e.src=r.result},r.onerror=n,r.readAsDataURL(e)}))}function Bt(e){let{Image:t,Video:n}=_.getEnv();return e instanceof t?new S(e.naturalWidth,e.naturalHeight):e instanceof n?new S(e.videoWidth,e.videoHeight):new S(e.width,e.height)}function Rt({width:e,height:t}){let{createCanvasElement:n}=_.getEnv(),r=n();return r.width=e,r.height=t,r}function be(e,t){let{ImageData:n}=_.getEnv();if(!(e instanceof n||he(e)))throw new Error("createCanvasFromMedia - media has not finished loading yet");let{width:r,height:a}=t||Bt(e),i=Rt({width:r,height:a});return e instanceof n?k(i).putImageData(e,0,0):k(i).drawImage(e,0,0,r,a),i}async function Pr(e,t){let r=t||_.getEnv().createCanvasElement(),[a,i,o]=e.shape.slice(R(e)?1:0),s=n.tidy((()=>e.as3D(a,i,o).toInt()));return await n.browser.toPixels(s,r),s.dispose(),r}function Qe(e){let{Image:t,Canvas:n,Video:r}=_.getEnv();return e instanceof t||e instanceof n||e instanceof r}function Fr(e,t,n=!1){let{Image:r,Canvas:a}=_.getEnv();if(!(e instanceof r||e instanceof a))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");if(t<=0)return Rt({width:1,height:1});let i=Bt(e),o=t/Math.max(i.height,i.width),s=o*i.width,c=o*i.height,h=Rt({width:t,height:t}),l=e instanceof a?e:be(e),d=Math.abs(s-c)/2,u=n&&s<c?d:0,p=n&&c<s?d:0;return l.width>0&&l.height>0&&k(h).drawImage(l,u,p,s,c),h}var rt=class{constructor(e,t=!1){if(this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],this._inputSize=0,!Array.isArray(e))throw new Error(`NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have ${e}`);this._treatAsBatchInput=t,this._batchSize=e.length,e.forEach(((e,t)=>{if(K(e))return this._imageTensors[t]=e,void(this._inputDimensions[t]=e.shape);if(R(e)){let n=e.shape[0];if(1!==n)throw new Error(`NetInput - tf.Tensor4D with batchSize ${n} passed, but not supported in input array`);return this._imageTensors[t]=e,void(this._inputDimensions[t]=e.shape.slice(1))}let n=e instanceof _.getEnv().Canvas?e:be(e);this._canvases[t]=n,this._inputDimensions[t]=[n.height,n.width,3]}))}get imageTensors(){return this._imageTensors}get canvases(){return this._canvases}get isBatchInput(){return this.batchSize>1||this._treatAsBatchInput}get batchSize(){return this._batchSize}get inputDimensions(){return this._inputDimensions}get inputSize(){return this._inputSize}get reshapedInputDimensions(){return U(this.batchSize,0,1).map(((e,t)=>this.getReshapedInputDimensions(t)))}getInput(e){return this.canvases[e]||this.imageTensors[e]}getInputDimensions(e){return this._inputDimensions[e]}getInputHeight(e){return this._inputDimensions[e][0]}getInputWidth(e){return this._inputDimensions[e][1]}getReshapedInputDimensions(e){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return je({width:this.getInputWidth(e),height:this.getInputHeight(e)},this.inputSize)}toBatchTensor(e,t=!0){return this._inputSize=e,n.tidy((()=>{let r=U(this.batchSize,0,1).map((r=>{let a=this.getInput(r);if(a instanceof n.Tensor){let r=R(a)?a:n.expandDims(a);return r=vr(r,t),(r.shape[1]!==e||r.shape[2]!==e)&&(r=n.image.resizeBilinear(r,[e,e],!1,!1)),r.as3D(e,e,3)}if(a instanceof _.getEnv().Canvas)return n.browser.fromPixels(Fr(a,e,t));throw new Error(`toBatchTensor - at batchIdx ${r}, expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have ${a}`)}));return n.stack(r.map((e=>n.cast(e,"float32")))).as4D(this.batchSize,e,e,3)}))}};async function M(e){if(e instanceof rt)return e;let t=Array.isArray(e)?e:[e];if(!t.length)throw new Error("toNetInput - empty array passed as input");let n=t=>Array.isArray(e)?` at input index ${t}:`:"",r=t.map(Wt);return r.forEach(((e,r)=>{if(!Qe(e)&&!K(e)&&!R(e))throw"string"==typeof t[r]?new Error(`toNetInput -${n(r)} string passed, but could not resolve HTMLElement for element id ${t[r]}`):new Error(`toNetInput -${n(r)} expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id`);if(R(e)){let t=e.shape[0];if(1!==t)throw new Error(`toNetInput -${n(r)} tf.Tensor4D with batchSize ${t} passed, but not supported in input array`)}})),await Promise.all(r.map((e=>Qe(e)&&Tr(e)))),new rt(r,Array.isArray(e))}async function re(e,t){let{Canvas:n}=_.getEnv(),r=e;if(!(e instanceof n)){let t=await M(e);if(t.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");let a=t.getInput(0);r=a instanceof n?a:await Pr(a)}let a=k(r);return t.map((e=>e instanceof E?e.forSize(r.width,r.height).box.floor():e)).map((e=>e.clipAtImageBorders(r.width,r.height))).map((({x:e,y:t,width:n,height:r})=>{let i=Rt({width:n,height:r});return n>0&&r>0&&k(i).putImageData(a.getImageData(e,t,n,r),0,0),i}))}async function oe(e,t){if(!K(e)&&!R(e))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(R(e)&&e.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return n.tidy((()=>{let[r,a,i]=e.shape.slice(R(e)?1:0);return t.map((e=>e instanceof E?e.forSize(a,r).box:e)).map((e=>e.clipAtImageBorders(a,r))).filter((e=>e.width>0&&e.height>0)).map((({x:t,y:o,width:s,height:c})=>n.slice3d(e.as3D(r,a,i),[o,t,0],[c,s,i])))}))}async function mt(e,t){let{fetch:n}=_.getEnv(),r=await n(e,t);if(!(r.status<400))throw new Error(`failed to fetch: (${r.status}) ${r.statusText}, from url: ${r.url}`);return r}async function Fi(e){let t=await mt(e),n=await t.blob();if(!n.type.startsWith("image/"))throw new Error(`fetchImage - expected blob type to be of type image/*, instead have: ${n.type}, for url: ${t.url}`);return wr(n)}async function Dr(e){return(await mt(e)).json()}async function Ii(e){return new Float32Array(await(await mt(e)).arrayBuffer())}function Er(e){return new Promise(((t,n)=>{e instanceof Blob||n(new Error("bufferToVideo - expected buf to be of type: Blob"));let r=_.getEnv().createVideoElement();r.oncanplay=()=>t(r),r.onerror=n,r.playsInline=!0,r.muted=!0,r.src=URL.createObjectURL(e),r.play()}))}async function ki(e){let t=await mt(e),n=await t.blob();if(!n.type.startsWith("video/"))throw new Error(`fetchVideo - expected blob type to be of type video/*, instead have: ${n.type}, for url: ${t.url}`);return Er(n)}function ge(e,t){let n=`${t}-weights_manifest.json`;if(!e)return{modelBaseUri:"",manifestUri:n};if("/"===e)return{modelBaseUri:"/",manifestUri:`/${n}`};let r=e.startsWith("http://")?"http://":e.startsWith("https://")?"https://":"",a=(e=e.replace(r,"")).split("/").filter((e=>e)),i=e.endsWith(".json")?a[a.length-1]:n,o=r+(e.endsWith(".json")?a.slice(0,a.length-1):a).join("/");return o=e.startsWith("/")?`/${o}`:o,{modelBaseUri:o,manifestUri:"/"===o?`/${i}`:`${o}/${i}`}}async function Mr(e,t){let{manifestUri:r,modelBaseUri:a}=ge(e,t),i=await Dr(r);return n.io.loadWeights(i,a)}function Vi(e,t,n=!1){let{width:r,height:a}=n?Bt(t):t;return e.width=r,e.height=a,{width:r,height:a}}var I=class{constructor(e){this._params=void 0,this._paramMappings=[],this._name=e}get params(){return this._params}get paramMappings(){return this._paramMappings}get isLoaded(){return!!this.params}getParamFromPath(e){let{obj:t,objProp:n}=this.traversePropertyPath(e);return t[n]}reassignParamFromPath(e,t){let{obj:n,objProp:r}=this.traversePropertyPath(e);n[r].dispose(),n[r]=t}getParamList(){return this._paramMappings.map((({paramPath:e})=>({path:e,tensor:this.getParamFromPath(e)})))}getTrainableParams(){return this.getParamList().filter((e=>e.tensor instanceof n.Variable))}getFrozenParams(){return this.getParamList().filter((e=>!(e.tensor instanceof n.Variable)))}variable(){this.getFrozenParams().forEach((({path:e,tensor:t})=>{this.reassignParamFromPath(e,t.variable())}))}freeze(){this.getTrainableParams().forEach((({path:e,tensor:t})=>{let r=n.tensor(t.dataSync());t.dispose(),this.reassignParamFromPath(e,r)}))}dispose(e=!0){this.getParamList().forEach((t=>{if(e&&t.tensor.isDisposed)throw new Error(`param tensor has already been disposed for path ${t.path}`);t.tensor.dispose()})),this._params=void 0}serializeParams(){return new Float32Array(this.getParamList().map((({tensor:e})=>Array.from(e.dataSync()))).reduce(((e,t)=>e.concat(t))))}async load(e){e instanceof Float32Array?this.extractWeights(e):await this.loadFromUri(e)}async loadFromUri(e){if(e&&"string"!=typeof e)throw new Error(`${this._name}.loadFromUri - expected model uri`);let t=await Mr(e,this.getDefaultModelName());this.loadFromWeightMap(t)}async loadFromDisk(e){if(e&&"string"!=typeof e)throw new Error(`${this._name}.loadFromDisk - expected model file path`);let{readFile:t}=_.getEnv(),{manifestUri:r,modelBaseUri:a}=ge(e,this.getDefaultModelName()),i=n.io.weightsLoaderFactory((e=>Promise.all(e.map((e=>t(e).then((e=>e.buffer))))))),o=JSON.parse((await t(r)).toString()),s=await i(o,a);this.loadFromWeightMap(s)}loadFromWeightMap(e){let{paramMappings:t,params:n}=this.extractParamsFromWeightMap(e);this._paramMappings=t,this._params=n}extractWeights(e){let{paramMappings:t,params:n}=this.extractParams(e);this._paramMappings=t,this._params=n}traversePropertyPath(e){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");let t=e.split("/").reduce(((t,n)=>{if(!t.nextObj.hasOwnProperty(n))throw new Error(`traversePropertyPath - object does not have property ${n}, for path ${e}`);return{obj:t.nextObj,objProp:n,nextObj:t.nextObj[n]}}),{nextObj:this.params}),{obj:r,objProp:a}=t;if(!(r&&a&&r[a]instanceof n.Tensor))throw new Error(`traversePropertyPath - parameter is not a tensor, for path ${e}`);return{obj:r,objProp:a}}};function W(e,t,r){return n.tidy((()=>{let a=n.separableConv2d(e,t.depthwise_filter,t.pointwise_filter,r,"same");return a=n.add(a,t.bias),a}))}function xe(e,t,r=!1){return n.tidy((()=>{let a=n.relu(r?n.add(n.conv2d(e,t.conv0.filters,[2,2],"same"),t.conv0.bias):W(e,t.conv0,[2,2])),i=W(a,t.conv1,[1,1]),o=W(n.relu(n.add(a,i)),t.conv2,[1,1]);return n.relu(n.add(a,n.add(i,o)))}))}function ne(e,t,r=!1,a=!0){return n.tidy((()=>{let i=n.relu(r?n.add(n.conv2d(e,t.conv0.filters,a?[2,2]:[1,1],"same"),t.conv0.bias):W(e,t.conv0,a?[2,2]:[1,1])),o=W(i,t.conv1,[1,1]),s=W(n.relu(n.add(i,o)),t.conv2,[1,1]),c=W(n.relu(n.add(i,n.add(o,s))),t.conv3,[1,1]);return n.relu(n.add(i,n.add(o,n.add(s,c))))}))}function _t(e,t,r="same",a=!1){return n.tidy((()=>{let i=n.add(n.conv2d(e,t.filters,[1,1],r),t.bias);return a?n.relu(i):i}))}function L(e,t){Object.keys(e).forEach((n=>{t.some((e=>e.originalPath===n))||e[n].dispose()}))}function $t(e,t){return(r,a,i,o)=>{let s=n.tensor4d(e(r*a*i*i),[i,i,r,a]),c=n.tensor1d(e(a));return t.push({paramPath:`${o}/filters`},{paramPath:`${o}/bias`}),{filters:s,bias:c}}}function ve(e,t){return(r,a,i)=>{let o=n.tensor2d(e(r*a),[r,a]),s=n.tensor1d(e(a));return t.push({paramPath:`${i}/weights`},{paramPath:`${i}/bias`}),{weights:o,bias:s}}}var ae=class{constructor(e,t,n){this.depthwise_filter=e,this.pointwise_filter=t,this.bias=n}};function Ot(e,t){return(r,a,i)=>{let o=n.tensor4d(e(9*r),[3,3,r,1]),s=n.tensor4d(e(r*a),[1,1,r,a]),c=n.tensor1d(e(a));return t.push({paramPath:`${i}/depthwise_filter`},{paramPath:`${i}/pointwise_filter`},{paramPath:`${i}/bias`}),new ae(o,s,c)}}function Ht(e){return t=>{let n=e(`${t}/depthwise_filter`,4),r=e(`${t}/pointwise_filter`,4),a=e(`${t}/bias`,1);return new ae(n,r,a)}}function B(e,t){return(n,r,a)=>{let i=e[n];if(!xt(i,r))throw new Error(`expected weightMap[${n}] to be a Tensor${r}D, instead have ${i}`);return t.push({originalPath:n,paramPath:a||n}),i}}function A(e){let t=e;return{extractWeights:function(e){let n=t.slice(0,e);return t=t.slice(e),n},getRemainingWeights:function(){return t}}}function ye(e,t){let n=$t(e,t),r=Ot(e,t);function a(e,t,a,i=!1){return{conv0:i?n(e,t,3,`${a}/conv0`):r(e,t,`${a}/conv0`),conv1:r(t,t,`${a}/conv1`),conv2:r(t,t,`${a}/conv2`)}}return{extractDenseBlock3Params:a,extractDenseBlock4Params:function(e,t,n,i=!1){let{conv0:o,conv1:s,conv2:c}=a(e,t,n,i);return{conv0:o,conv1:s,conv2:c,conv3:r(t,t,`${n}/conv3`)}}}}function Cr(e){let t=[],{extractWeights:n,getRemainingWeights:r}=A(e),{extractDenseBlock4Params:a}=ye(n,t),i=a(3,32,"dense0",!0),o=a(32,64,"dense1"),s=a(64,128,"dense2"),c=a(128,256,"dense3");if(0!==r().length)throw new Error(`weights remaing after extract: ${r().length}`);return{paramMappings:t,params:{dense0:i,dense1:o,dense2:s,dense3:c}}}function _e(e){return t=>({filters:e(`${t}/filters`,4),bias:e(`${t}/bias`,1)})}function Te(e,t){let n=B(e,t),r=_e(n),a=Ht(n);return{extractDenseBlock3Params:function(e,t=!1){return{conv0:t?r(`${e}/conv0`):a(`${e}/conv0`),conv1:a(`${e}/conv1`),conv2:a(`${e}/conv2`)}},extractDenseBlock4Params:function(e,t=!1){return{conv0:t?r(`${e}/conv0`):a(`${e}/conv0`),conv1:a(`${e}/conv1`),conv2:a(`${e}/conv2`),conv3:a(`${e}/conv3`)}}}}function Ir(e){let t=[],{extractDenseBlock4Params:n}=Te(e,t),r={dense0:n("dense0",!0),dense1:n("dense1"),dense2:n("dense2"),dense3:n("dense3")};return L(e,t),{params:r,paramMappings:t}}var zt=class extends I{constructor(){super("FaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceFeatureExtractor - load model before inference");return n.tidy((()=>{let r=ne(X(n.cast(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),t.dense0,!0);return r=ne(r,t.dense1),r=ne(r,t.dense2),r=ne(r,t.dense3),r=n.avgPool(r,[7,7],[2,2],"valid"),r}))}async forward(e){return this.forwardInput(await M(e))}getDefaultModelName(){return"face_feature_extractor_model"}extractParamsFromWeightMap(e){return Ir(e)}extractParams(e){return Cr(e)}};function se(e,t){return n.tidy((()=>n.add(n.matMul(e,t.weights),t.bias)))}function Nr(e,t,n){let r=[],{extractWeights:a,getRemainingWeights:i}=A(e),o=ve(a,r)(t,n,"fc");if(0!==i().length)throw new Error(`weights remaing after extract: ${i().length}`);return{paramMappings:r,params:{fc:o}}}function Sr(e){let t=[],n=B(e,t),r={fc:("fc",{weights:n("fc/weights",2),bias:n("fc/bias",1)})};return L(e,t),{params:r,paramMappings:t}}function we(e){let t={},n={};return Object.keys(e).forEach((r=>{(r.startsWith("fc")?n:t)[r]=e[r]})),{featureExtractorMap:t,classifierMap:n}}var Vt=class extends I{constructor(e,t){super(e),this._faceFeatureExtractor=t}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return n.tidy((()=>{let n=e instanceof rt?this.faceFeatureExtractor.forwardInput(e):e;return se(n.as2D(n.shape[0],-1),t.fc)}))}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:n}=this.extractClassifierParams(e);this._params=t,this._paramMappings=n}extractClassifierParams(e){return Nr(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:n}=we(e);return this.faceFeatureExtractor.loadFromWeightMap(t),Sr(n)}extractParams(e){let t=this.getClassifierChannelsIn(),n=this.getClassifierChannelsOut(),r=n*t+n,a=e.slice(0,e.length-r),i=e.slice(e.length-r);return this.faceFeatureExtractor.extractWeights(a),this.extractClassifierParams(i)}},Lr=["neutral","happy","sad","angry","fearful","disgusted","surprised"],pt=class{constructor(e){if(this.neutral=0,this.happy=0,this.sad=0,this.angry=0,this.fearful=0,this.disgusted=0,this.surprised=0,7!==e.length)throw new Error(`FaceExpressions.constructor - expected probabilities.length to be 7, have: ${e.length}`);Lr.forEach(((t,n)=>{this[t]=e[n]}))}asSortedArray(){return Lr.map((e=>({expression:e,probability:this[e]}))).sort(((e,t)=>t.probability-e.probability))}},Pe=class extends Vt{constructor(e=new zt){super("FaceExpressionNet",e)}forwardInput(e){return n.tidy((()=>n.softmax(this.runNet(e))))}async forward(e){return this.forwardInput(await M(e))}async predictExpressions(e){let t=await M(e),r=await this.forwardInput(t),a=await Promise.all(n.unstack(r).map((async e=>{let t=e.dataSync();return e.dispose(),t})));r.dispose();let i=a.map((e=>new pt(e)));return t.isBatchInput?i:i[0]}getDefaultModelName(){return"face_expression_model"}getClassifierChannelsIn(){return 256}getClassifierChannelsOut(){return 7}};function Ar(e){return e.expressions instanceof pt}function tr(e,t){return{...e,expressions:t}}function So(e,t,n=.1,r){(Array.isArray(t)?t:[t]).forEach((t=>{let a=t instanceof pt?t:Ar(t)?t.expressions:void 0;if(!a)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");let i=a.asSortedArray().filter((e=>e.probability>n)),o=tt(t)?t.detection.box.bottomLeft:r||new g(0,0);new et(i.map((e=>`${e.expression} (${vt(e.probability)})`)),o).draw(e)}))}function Yt(e){return tt(e)&&e.landmarks instanceof $&&e.unshiftedLandmarks instanceof $&&e.alignedRect instanceof E}function Lo(e){let t=e=>180*e/Math.PI,n=(e,t)=>Math.sqrt((e._x-t._x)**2+(e._y-t._y)**2),r={roll:void 0,pitch:void 0,yaw:void 0};if(!e||!e._positions||68!==e._positions.length)return r;let a=e._positions;return r.roll=((e,n)=>{let r=Math.hypot(n._x-e._x,n._y-e._y),a=n._y-e._y,i=Math.asin(a/r),o=t(i);return Math.floor(90-o)*(n._x-e._x<0?-1:1)})(a[27],a[66]),r.pitch=((e,r,a)=>{let i=n(e,a),o={_x:(e._x+a._x)/2,_y:(e._y+a._y)/2},s=n(r,o),c=Math.atan(s/i);return Math.floor(t(c))*(o._y-r._y<0?-1:1)})(a[14],a[30],a[2]),r.yaw=(i=a[14],o=a[33],s=a[2],Math.floor(i._x-o._x)-Math.floor(o._x-s._x)),r;var i,o,s}function ie(e,t){let{box:n}=e.detection,r=t.shiftBy(n.x,n.y),a=r.align(),{imageDims:i}=e.detection,o=new E(e.detection.score,a.rescale(i.reverse()),i),s=Lo(t);return{...e,landmarks:r,unshiftedLandmarks:t,alignedRect:o,angle:s}}var Fe=class{constructor(e={}){let{drawLines:t=!0,drawPoints:n=!0,lineWidth:r,lineColor:a,pointSize:i,pointColor:o}=e;this.drawLines=t,this.drawPoints=n,this.lineWidth=r||1,this.pointSize=i||2,this.lineColor=a||"rgba(0, 255, 255, 1)",this.pointColor=o||"rgba(255, 0, 255, 1)"}},De=class{constructor(e,t={}){this.faceLandmarks=e,this.options=new Fe(t)}draw(e){let t=k(e),{drawLines:n,drawPoints:r,lineWidth:a,lineColor:i,pointSize:o,pointColor:s}=this.options;if(n&&this.faceLandmarks instanceof Lt&&(t.strokeStyle=i,t.lineWidth=a,Z(t,this.faceLandmarks.getJawOutline()),Z(t,this.faceLandmarks.getLeftEyeBrow()),Z(t,this.faceLandmarks.getRightEyeBrow()),Z(t,this.faceLandmarks.getNose()),Z(t,this.faceLandmarks.getLeftEye(),!0),Z(t,this.faceLandmarks.getRightEye(),!0),Z(t,this.faceLandmarks.getMouth(),!0)),r){t.strokeStyle=s,t.fillStyle=s;let e=e=>{t.beginPath(),t.arc(e.x,e.y,o,0,2*Math.PI),t.fill()};this.faceLandmarks.positions.forEach(e)}}};function Ao(e,t){(Array.isArray(t)?t:[t]).forEach((t=>{let n=t instanceof $?t:Yt(t)?t.landmarks:void 0;if(!n)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new De(n).draw(e)}))}var kr="1.7.7";function Bo(e,t){let n=$t(e,t),r=Ot(e,t);return{extractConvParams:n,extractSeparableConvParams:r,extractReductionBlockParams:function(e,t,a){return{separable_conv0:r(e,t,`${a}/separable_conv0`),separable_conv1:r(t,t,`${a}/separable_conv1`),expansion_conv:n(e,t,1,`${a}/expansion_conv`)}},extractMainBlockParams:function(e,t){return{separable_conv0:r(e,e,`${t}/separable_conv0`),separable_conv1:r(e,e,`${t}/separable_conv1`),separable_conv2:r(e,e,`${t}/separable_conv2`)}}}}function Br(e,t){let n=[],{extractWeights:r,getRemainingWeights:a}=A(e),{extractConvParams:i,extractSeparableConvParams:o,extractReductionBlockParams:s,extractMainBlockParams:c}=Bo(r,n),h={conv_in:i(3,32,3,"entry_flow/conv_in"),reduction_block_0:s(32,64,"entry_flow/reduction_block_0"),reduction_block_1:s(64,128,"entry_flow/reduction_block_1")},l={};U(t,0,1).forEach((e=>{l[`main_block_${e}`]=c(128,`middle_flow/main_block_${e}`)}));let d={reduction_block:s(128,256,"exit_flow/reduction_block"),separable_conv:o(256,512,"exit_flow/separable_conv")};if(0!==a().length)throw new Error(`weights remaing after extract: ${a().length}`);return{paramMappings:n,params:{entry_flow:h,middle_flow:l,exit_flow:d}}}function Ro(e,t){let n=B(e,t),r=_e(n),a=Ht(n);return{extractConvParams:r,extractSeparableConvParams:a,extractReductionBlockParams:function(e){return{separable_conv0:a(`${e}/separable_conv0`),separable_conv1:a(`${e}/separable_conv1`),expansion_conv:r(`${e}/expansion_conv`)}},extractMainBlockParams:function(e){return{separable_conv0:a(`${e}/separable_conv0`),separable_conv1:a(`${e}/separable_conv1`),separable_conv2:a(`${e}/separable_conv2`)}}}}function Rr(e,t){let n=[],{extractConvParams:r,extractSeparableConvParams:a,extractReductionBlockParams:i,extractMainBlockParams:o}=Ro(e,n),s={conv_in:r("entry_flow/conv_in"),reduction_block_0:i("entry_flow/reduction_block_0"),reduction_block_1:i("entry_flow/reduction_block_1")},c={};U(t,0,1).forEach((e=>{c[`main_block_${e}`]=o(`middle_flow/main_block_${e}`)}));let h={reduction_block:i("exit_flow/reduction_block"),separable_conv:a("exit_flow/separable_conv")};return L(e,n),{params:{entry_flow:s,middle_flow:c,exit_flow:h},paramMappings:n}}function $r(e,t,r){return n.add(n.conv2d(e,t.filters,r,"same"),t.bias)}function er(e,t,r=!0){let a=r?n.relu(e):e;return a=W(a,t.separable_conv0,[1,1]),a=W(n.relu(a),t.separable_conv1,[1,1]),a=n.maxPool(a,[3,3],[2,2],"same"),a=n.add(a,$r(e,t.expansion_conv,[2,2])),a}function $o(e,t){let r=W(n.relu(e),t.separable_conv0,[1,1]);return r=W(n.relu(r),t.separable_conv1,[1,1]),r=W(n.relu(r),t.separable_conv2,[1,1]),r=n.add(r,e),r}var Ee=class extends I{constructor(e){super("TinyXception"),this._numMainBlocks=e}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyXception - load model before inference");return n.tidy((()=>{let r=X(n.cast(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),a=n.relu($r(r,t.entry_flow.conv_in,[2,2]));return a=er(a,t.entry_flow.reduction_block_0,!1),a=er(a,t.entry_flow.reduction_block_1),U(this._numMainBlocks,0,1).forEach((e=>{a=$o(a,t.middle_flow[`main_block_${e}`])})),a=er(a,t.exit_flow.reduction_block),a=n.relu(W(a,t.exit_flow.separable_conv,[1,1])),a}))}async forward(e){return this.forwardInput(await M(e))}getDefaultModelName(){return"tiny_xception_model"}extractParamsFromWeightMap(e){return Rr(e,this._numMainBlocks)}extractParams(e){return Br(e,this._numMainBlocks)}};function Or(e){let t=[],{extractWeights:n,getRemainingWeights:r}=A(e),a=ve(n,t),i=a(512,1,"fc/age"),o=a(512,2,"fc/gender");if(0!==r().length)throw new Error(`weights remaing after extract: ${r().length}`);return{paramMappings:t,params:{fc:{age:i,gender:o}}}}function Hr(e){let t=[],n=B(e,t);function r(e){return{weights:n(`${e}/weights`,2),bias:n(`${e}/bias`,1)}}let a={fc:{age:r("fc/age"),gender:r("fc/gender")}};return L(e,t),{params:a,paramMappings:t}}var rr=(e=>(e.FEMALE="female",e.MALE="male",e))(rr||{}),Me=class extends I{constructor(e=new Ee(2)){super("AgeGenderNet"),this._faceFeatureExtractor=e}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return n.tidy((()=>{let r=e instanceof rt?this.faceFeatureExtractor.forwardInput(e):e,a=n.avgPool(r,[7,7],[2,2],"valid").as2D(r.shape[0],-1);return{age:se(a,t.fc.age).as1D(),gender:se(a,t.fc.gender)}}))}forwardInput(e){return n.tidy((()=>{let{age:t,gender:r}=this.runNet(e);return{age:t,gender:n.softmax(r)}}))}async forward(e){return this.forwardInput(await M(e))}async predictAgeAndGender(e){let t=await M(e),r=await this.forwardInput(t),a=n.unstack(r.age),i=n.unstack(r.gender),o=a.map(((e,t)=>({ageTensor:e,genderTensor:i[t]}))),s=await Promise.all(o.map((async({ageTensor:e,genderTensor:t})=>{let n=e.dataSync()[0],r=t.dataSync()[0],a=r>.5,i=a?"male":"female",o=a?r:1-r;return e.dispose(),t.dispose(),{age:n,gender:i,genderProbability:o}})));return r.age.dispose(),r.gender.dispose(),t.isBatchInput?s:s[0]}getDefaultModelName(){return"age_gender_model"}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:n}=this.extractClassifierParams(e);this._params=t,this._paramMappings=n}extractClassifierParams(e){return Or(e)}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:n}=we(e);return this.faceFeatureExtractor.loadFromWeightMap(t),Hr(n)}extractParams(e){let t=e.slice(0,e.length-1539),n=e.slice(e.length-1539);return this.faceFeatureExtractor.extractWeights(t),this.extractClassifierParams(n)}},Gt=class extends Vt{postProcess(e,t,r){let a=r.map((({width:e,height:n})=>{let r=t/Math.max(n,e);return{width:e*r,height:n*r}})),i=a.length;return n.tidy((()=>{let r=(e,t)=>n.stack([n.fill([68],e,"float32"),n.fill([68],t,"float32")],1).as2D(1,136).as1D(),o=(e,t)=>{let{width:n,height:r}=a[e];return t(n,r)?Math.abs(n-r)/2:0};return e.mul(n.fill([i,136],t,"float32")).sub(n.stack(Array.from(Array(i),((e,t)=>r((e=>o(e,((e,t)=>e<t)))(t),(e=>o(e,((e,t)=>t<e)))(t)))))).div(n.stack(Array.from(Array(i),((e,t)=>r(a[t].width,a[t].height)))))}))}forwardInput(e){return n.tidy((()=>{let t=this.runNet(e);return this.postProcess(t,e.inputSize,e.inputDimensions.map((([e,t])=>({height:e,width:t}))))}))}async forward(e){return this.forwardInput(await M(e))}async detectLandmarks(e){let t=await M(e),r=n.tidy((()=>n.unstack(this.forwardInput(t)))),a=await Promise.all(r.map((async(e,n)=>{let r=Array.from(e.dataSync()),a=r.filter(((e,t)=>pe(t))),i=r.filter(((e,t)=>!pe(t)));return new Lt(Array(68).fill(0).map(((e,t)=>new g(a[t],i[t]))),{height:t.getInputHeight(n),width:t.getInputWidth(n)})})));return r.forEach((e=>e.dispose())),t.isBatchInput?a:a[0]}getClassifierChannelsOut(){return 136}},jt=class extends Gt{constructor(e=new zt){super("FaceLandmark68Net",e)}getDefaultModelName(){return"face_landmark_68_model"}getClassifierChannelsIn(){return 256}};function zr(e){let t=[],{extractDenseBlock3Params:n}=Te(e,t),r={dense0:n("dense0",!0),dense1:n("dense1"),dense2:n("dense2")};return L(e,t),{params:r,paramMappings:t}}function Vr(e){let t=[],{extractWeights:n,getRemainingWeights:r}=A(e),{extractDenseBlock3Params:a}=ye(n,t),i=a(3,32,"dense0",!0),o=a(32,64,"dense1"),s=a(64,128,"dense2");if(0!==r().length)throw new Error(`weights remaing after extract: ${r().length}`);return{paramMappings:t,params:{dense0:i,dense1:o,dense2:s}}}var Ce=class extends I{constructor(){super("TinyFaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyFaceFeatureExtractor - load model before inference");return n.tidy((()=>{let r=xe(X(n.cast(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),t.dense0,!0);return r=xe(r,t.dense1),r=xe(r,t.dense2),r=n.avgPool(r,[14,14],[2,2],"valid"),r}))}async forward(e){return this.forwardInput(await M(e))}getDefaultModelName(){return"face_feature_extractor_tiny_model"}extractParamsFromWeightMap(e){return zr(e)}extractParams(e){return Vr(e)}},Ie=class extends Gt{constructor(e=new Ce){super("FaceLandmark68TinyNet",e)}getDefaultModelName(){return"face_landmark_68_tiny_model"}getClassifierChannelsIn(){return 128}},Yr=class extends jt{};function Gr(e,t){return n.add(n.mul(e,t.weights),t.biases)}function or(e,t,r,a,i="same"){let{filters:o,bias:s}=t.conv,c=n.conv2d(e,o,r,i);return c=n.add(c,s),c=Gr(c,t.scale),a?n.relu(c):c}function jr(e,t){return or(e,t,[1,1],!0)}function nr(e,t){return or(e,t,[1,1],!1)}function Ne(e,t){return or(e,t,[2,2],!0,"valid")}function Oo(e,t){function r(r,a,i,o){let s=function(r,a,i,o){let s=function(t,r,a){let i=e(t),o=i.length/(r*a*a);if(Ge(o))throw new Error(`depth has to be an integer: ${o}, weights.length: ${i.length}, numFilters: ${r}, filterSize: ${a}`);return n.tidy((()=>n.transpose(n.tensor4d(i,[r,o,a,a]),[2,3,1,0])))}(r,a,i),c=n.tensor1d(e(a));return t.push({paramPath:`${o}/filters`},{paramPath:`${o}/bias`}),{filters:s,bias:c}}(r,a,i,`${o}/conv`),c=function(r,a){let i=n.tensor1d(e(r)),o=n.tensor1d(e(r));return t.push({paramPath:`${a}/weights`},{paramPath:`${a}/biases`}),{weights:i,biases:o}}(a,`${o}/scale`);return{conv:s,scale:c}}return{extractConvLayerParams:r,extractResidualLayerParams:function(e,t,n,a,i=!1){return{conv1:r((i?.5:1)*e,t,n,`${a}/conv1`),conv2:r(e,t,n,`${a}/conv2`)}}}}function Ur(e){let{extractWeights:t,getRemainingWeights:r}=A(e),a=[],{extractConvLayerParams:i,extractResidualLayerParams:o}=Oo(t,a),s=i(4704,32,7,"conv32_down"),c=o(9216,32,3,"conv32_1"),h=o(9216,32,3,"conv32_2"),l=o(9216,32,3,"conv32_3"),d=o(36864,64,3,"conv64_down",!0),u=o(36864,64,3,"conv64_1"),p=o(36864,64,3,"conv64_2"),f=o(36864,64,3,"conv64_3"),m=o(147456,128,3,"conv128_down",!0),g=o(147456,128,3,"conv128_1"),_=o(147456,128,3,"conv128_2"),w=o(589824,256,3,"conv256_down",!0),v=o(589824,256,3,"conv256_1"),b=o(589824,256,3,"conv256_2"),x=o(589824,256,3,"conv256_down_out"),y=n.tidy((()=>n.transpose(n.tensor2d(t(32768),[128,256]),[1,0])));if(a.push({paramPath:"fc"}),0!==r().length)throw new Error(`weights remaing after extract: ${r().length}`);return{params:{conv32_down:s,conv32_1:c,conv32_2:h,conv32_3:l,conv64_down:d,conv64_1:u,conv64_2:p,conv64_3:f,conv128_down:m,conv128_1:g,conv128_2:_,conv256_down:w,conv256_1:v,conv256_2:b,conv256_down_out:x,fc:y},paramMappings:a}}function Ho(e,t){let n=B(e,t);function r(e){let t=n(`${e}/conv/filters`,4),r=n(`${e}/conv/bias`,1),a=function(e){return{weights:n(`${e}/scale/weights`,1),biases:n(`${e}/scale/biases`,1)}}(e);return{conv:{filters:t,bias:r},scale:a}}return{extractConvLayerParams:r,extractResidualLayerParams:function(e){return{conv1:r(`${e}/conv1`),conv2:r(`${e}/conv2`)}}}}function Xr(e){let t=[],{extractConvLayerParams:n,extractResidualLayerParams:r}=Ho(e,t),a=n("conv32_down"),i=r("conv32_1"),o=r("conv32_2"),s=r("conv32_3"),c=r("conv64_down"),h=r("conv64_1"),l=r("conv64_2"),d=r("conv64_3"),u=r("conv128_down"),p=r("conv128_1"),f=r("conv128_2"),m=r("conv256_down"),g=r("conv256_1"),_=r("conv256_2"),w=r("conv256_down_out"),{fc:v}=e;if(t.push({originalPath:"fc",paramPath:"fc"}),!Ye(v))throw new Error(`expected weightMap[fc] to be a Tensor2D, instead have ${v}`);let b={conv32_down:a,conv32_1:i,conv32_2:o,conv32_3:s,conv64_down:c,conv64_1:h,conv64_2:l,conv64_3:d,conv128_down:u,conv128_1:p,conv128_2:f,conv256_down:m,conv256_1:g,conv256_2:_,conv256_down_out:w,fc:v};return L(e,t),{params:b,paramMappings:t}}function j(e,t){let r=jr(e,t.conv1);return r=nr(r,t.conv2),r=n.add(r,e),r=n.relu(r),r}function ce(e,t){let r=Ne(e,t.conv1);r=nr(r,t.conv2);let a=n.avgPool(e,2,2,"valid"),i=n.zeros(a.shape),o=a.shape[3]!==r.shape[3];if(a.shape[1]!==r.shape[1]||a.shape[2]!==r.shape[2]){let e=[...r.shape];e[1]=1;let t=n.zeros(e);r=n.concat([r,t],1);let a=[...r.shape];a[2]=1;let i=n.zeros(a);r=n.concat([r,i],2)}return a=o?n.concat([a,i],3):a,r=n.add(a,r),r=n.relu(r),r}var Ut=class extends I{constructor(){super("FaceRecognitionNet")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceRecognitionNet - load model before inference");return n.tidy((()=>{let r=Ne(X(n.cast(e.toBatchTensor(150,!0),"float32"),[122.782,117.001,104.298]).div(255),t.conv32_down);r=n.maxPool(r,3,2,"valid"),r=j(r,t.conv32_1),r=j(r,t.conv32_2),r=j(r,t.conv32_3),r=ce(r,t.conv64_down),r=j(r,t.conv64_1),r=j(r,t.conv64_2),r=j(r,t.conv64_3),r=ce(r,t.conv128_down),r=j(r,t.conv128_1),r=j(r,t.conv128_2),r=ce(r,t.conv256_down),r=j(r,t.conv256_1),r=j(r,t.conv256_2),r=ce(r,t.conv256_down_out);let a=r.mean([1,2]);return n.matMul(a,t.fc)}))}async forward(e){return this.forwardInput(await M(e))}async computeFaceDescriptor(e){var t;if(null!=(t=null==e?void 0:e.shape)&&t.some((e=>e<=0)))return new Float32Array(128);let r=await M(e),a=n.tidy((()=>n.unstack(this.forwardInput(r)))),i=await Promise.all(a.map((e=>e.data())));return a.forEach((e=>e.dispose())),r.isBatchInput?i:i[0]}getDefaultModelName(){return"face_recognition_model"}extractParamsFromWeightMap(e){return Xr(e)}extractParams(e){return Ur(e)}};function bf(e){let t=new Ut;return t.extractWeights(e),t}function ar(e,t){return{...e,descriptor:t}}function yf(e){return"number"==typeof e.age}function sr(e,t){return{...e,age:t}}function Pf(e){return("male"===e.gender||"female"===e.gender)&&It(e.genderProbability)}function ir(e,t,n){return{...e,gender:t,genderProbability:n}}function zo(e,t){function r(r,a,i,o,s){let c=n.tensor4d(e(r*a*i*i),[i,i,r,a]),h=n.tensor1d(e(a));return t.push({paramPath:`${o}/filters`},{paramPath:`${o}/${s?"batch_norm_offset":"bias"}`}),{filters:c,bias:h}}function a(e,t,n,a){let{filters:i,bias:o}=r(e,t,n,a,!0);return{filters:i,batch_norm_offset:o}}function i(r,i,o){let s=function(r,a){let i=n.tensor4d(e(9*r),[3,3,r,1]),o=n.tensor1d(e(r)),s=n.tensor1d(e(r)),c=n.tensor1d(e(r)),h=n.tensor1d(e(r));return t.push({paramPath:`${a}/filters`},{paramPath:`${a}/batch_norm_scale`},{paramPath:`${a}/batch_norm_offset`},{paramPath:`${a}/batch_norm_mean`},{paramPath:`${a}/batch_norm_variance`}),{filters:i,batch_norm_scale:o,batch_norm_offset:s,batch_norm_mean:c,batch_norm_variance:h}}(r,`${o}/depthwise_conv`);return{depthwise_conv:s,pointwise_conv:a(r,i,1,`${o}/pointwise_conv`)}}return{extractMobilenetV1Params:function(){return{conv_0:a(3,32,3,"mobilenetv1/conv_0"),conv_1:i(32,64,"mobilenetv1/conv_1"),conv_2:i(64,128,"mobilenetv1/conv_2"),conv_3:i(128,128,"mobilenetv1/conv_3"),conv_4:i(128,256,"mobilenetv1/conv_4"),conv_5:i(256,256,"mobilenetv1/conv_5"),conv_6:i(256,512,"mobilenetv1/conv_6"),conv_7:i(512,512,"mobilenetv1/conv_7"),conv_8:i(512,512,"mobilenetv1/conv_8"),conv_9:i(512,512,"mobilenetv1/conv_9"),conv_10:i(512,512,"mobilenetv1/conv_10"),conv_11:i(512,512,"mobilenetv1/conv_11"),conv_12:i(512,1024,"mobilenetv1/conv_12"),conv_13:i(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:a(1024,256,1,"prediction_layer/conv_0"),conv_1:a(256,512,3,"prediction_layer/conv_1"),conv_2:a(512,128,1,"prediction_layer/conv_2"),conv_3:a(128,256,3,"prediction_layer/conv_3"),conv_4:a(256,128,1,"prediction_layer/conv_4"),conv_5:a(128,256,3,"prediction_layer/conv_5"),conv_6:a(256,64,1,"prediction_layer/conv_6"),conv_7:a(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:r(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:r(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:r(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:r(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:r(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:r(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:r(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:r(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:r(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:r(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:r(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:r(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}function Jr(e){let t=[],{extractWeights:r,getRemainingWeights:a}=A(e),{extractMobilenetV1Params:i,extractPredictionLayerParams:o}=zo(r,t),s=i(),c=o(),h={extra_dim:n.tensor3d(r(20472),[1,5118,4])};if(t.push({paramPath:"output_layer/extra_dim"}),0!==a().length)throw new Error(`weights remaing after extract: ${a().length}`);return{params:{mobilenetv1:s,prediction_layer:c,output_layer:h},paramMappings:t}}function Vo(e,t){let n=B(e,t);function r(e,t,r){return{filters:n(`${e}/Conv2d_${t}_pointwise/weights`,4,`${r}/filters`),batch_norm_offset:n(`${e}/Conv2d_${t}_pointwise/convolution_bn_offset`,1,`${r}/batch_norm_offset`)}}function a(e){let t=`mobilenetv1/conv_${e}`,a=`MobilenetV1/Conv2d_${e}_depthwise`,i=`${t}/depthwise_conv`,o=`${t}/pointwise_conv`;return{depthwise_conv:{filters:n(`${a}/depthwise_weights`,4,`${i}/filters`),batch_norm_scale:n(`${a}/BatchNorm/gamma`,1,`${i}/batch_norm_scale`),batch_norm_offset:n(`${a}/BatchNorm/beta`,1,`${i}/batch_norm_offset`),batch_norm_mean:n(`${a}/BatchNorm/moving_mean`,1,`${i}/batch_norm_mean`),batch_norm_variance:n(`${a}/BatchNorm/moving_variance`,1,`${i}/batch_norm_variance`)},pointwise_conv:r("MobilenetV1",e,o)}}function i(e,t){return{filters:n(`${e}/weights`,4,`${t}/filters`),bias:n(`${e}/biases`,1,`${t}/bias`)}}function o(e){return{box_encoding_predictor:i(`Prediction/BoxPredictor_${e}/BoxEncodingPredictor`,`prediction_layer/box_predictor_${e}/box_encoding_predictor`),class_predictor:i(`Prediction/BoxPredictor_${e}/ClassPredictor`,`prediction_layer/box_predictor_${e}/class_predictor`)}}return{extractMobilenetV1Params:function(){return{conv_0:r("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:a(1),conv_2:a(2),conv_3:a(3),conv_4:a(4),conv_5:a(5),conv_6:a(6),conv_7:a(7),conv_8:a(8),conv_9:a(9),conv_10:a(10),conv_11:a(11),conv_12:a(12),conv_13:a(13)}},extractPredictionLayerParams:function(){return{conv_0:r("Prediction",0,"prediction_layer/conv_0"),conv_1:r("Prediction",1,"prediction_layer/conv_1"),conv_2:r("Prediction",2,"prediction_layer/conv_2"),conv_3:r("Prediction",3,"prediction_layer/conv_3"),conv_4:r("Prediction",4,"prediction_layer/conv_4"),conv_5:r("Prediction",5,"prediction_layer/conv_5"),conv_6:r("Prediction",6,"prediction_layer/conv_6"),conv_7:r("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:o(0),box_predictor_1:o(1),box_predictor_2:o(2),box_predictor_3:o(3),box_predictor_4:o(4),box_predictor_5:o(5)}}}}function qr(e){let t=[],{extractMobilenetV1Params:n,extractPredictionLayerParams:r}=Vo(e,t),a=e["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!K(a))throw new Error(`expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have ${a}`);let i={mobilenetv1:n(),prediction_layer:r(),output_layer:{extra_dim:a}};return L(e,t),{params:i,paramMappings:t}}function H(e,t,r){return n.tidy((()=>{let a=n.conv2d(e,t.filters,r,"same");return a=n.add(a,t.batch_norm_offset),n.clipByValue(a,0,6)}))}var Yo=.0010000000474974513;function Go(e,t,r){return n.tidy((()=>{let a=n.depthwiseConv2d(e,t.filters,r,"same");return a=n.batchNorm(a,t.batch_norm_mean,t.batch_norm_variance,t.batch_norm_offset,t.batch_norm_scale,Yo),n.clipByValue(a,0,6)}))}function jo(e){return[2,4,6,12].some((t=>t===e))?[2,2]:[1,1]}function Zr(e,t){return n.tidy((()=>{let n,r=H(e,t.conv_0,[2,2]);if([t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13].forEach(((e,t)=>{let a=t+1,i=jo(a);r=Go(r,e.depthwise_conv,i),r=H(r,e.pointwise_conv,[1,1]),11===a&&(n=r)})),null===n)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:r,conv11:n}}))}function Uo(e,t,n){let r=e.arraySync(),a=Math.min(r[t][0],r[t][2]),i=Math.min(r[t][1],r[t][3]),o=Math.max(r[t][0],r[t][2]),s=Math.max(r[t][1],r[t][3]),c=Math.min(r[n][0],r[n][2]),h=Math.min(r[n][1],r[n][3]),l=Math.max(r[n][0],r[n][2]),d=Math.max(r[n][1],r[n][3]),u=(o-a)*(s-i),p=(l-c)*(d-h);if(u<=0||p<=0)return 0;let f=Math.max(a,c),m=Math.max(i,h),g=Math.min(o,l),_=Math.min(s,d),w=Math.max(g-f,0)*Math.max(_-m,0);return w/(u+p-w)}function Kr(e,t,n,r,a){let i=e.shape[0],o=Math.min(n,i),s=t.map(((e,t)=>({score:e,boxIndex:t}))).filter((e=>e.score>a)).sort(((e,t)=>t.score-e.score)),c=e=>e<=r?1:0,h=[];return s.forEach((t=>{if(h.length>=o)return;let n=t.score;for(let n=h.length-1;n>=0;--n){let r=Uo(e,t.boxIndex,h[n]);if(0!==r&&(t.score*=c(r),t.score<=a))break}n===t.score&&h.push(t.boxIndex)})),h}function Xo(e){let t=n.unstack(n.transpose(e,[1,0])),r=[n.sub(t[2],t[0]),n.sub(t[3],t[1])];return{sizes:r,centers:[n.add(t[0],n.div(r[0],2)),n.add(t[1],n.div(r[1],2))]}}function Jo(e,t){let{sizes:r,centers:a}=Xo(e),i=n.unstack(n.transpose(t,[1,0])),o=n.div(n.mul(n.exp(n.div(i[2],5)),r[0]),2),s=n.add(n.mul(n.div(i[0],10),r[0]),a[0]),c=n.div(n.mul(n.exp(n.div(i[3],5)),r[1]),2),h=n.add(n.mul(n.div(i[1],10),r[1]),a[1]);return n.transpose(n.stack([n.sub(s,o),n.sub(h,c),n.add(s,o),n.add(h,c)]),[1,0])}function Qr(e,t,r){return n.tidy((()=>{let a=e.shape[0],i=Jo(n.reshape(n.tile(r.extra_dim,[a,1,1]),[-1,4]),n.reshape(e,[-1,4]));i=n.reshape(i,[a,i.shape[0]/a,4]);let o=n.sigmoid(n.slice(t,[0,0,1],[-1,-1,-1])),s=n.slice(o,[0,0,0],[-1,-1,1]);return s=n.reshape(s,[a,s.shape[1]]),{boxes:n.unstack(i),scores:n.unstack(s)}}))}function Tt(e,t){return n.tidy((()=>{let r=e.shape[0];return{boxPredictionEncoding:n.reshape(_t(e,t.box_encoding_predictor),[r,-1,1,4]),classPrediction:n.reshape(_t(e,t.class_predictor),[r,-1,3])}}))}function to(e,t,r){return n.tidy((()=>{let a=H(e,r.conv_0,[1,1]),i=H(a,r.conv_1,[2,2]),o=H(i,r.conv_2,[1,1]),s=H(o,r.conv_3,[2,2]),c=H(s,r.conv_4,[1,1]),h=H(c,r.conv_5,[2,2]),l=H(h,r.conv_6,[1,1]),d=H(l,r.conv_7,[2,2]),u=Tt(t,r.box_predictor_0),p=Tt(e,r.box_predictor_1),f=Tt(i,r.box_predictor_2),m=Tt(s,r.box_predictor_3),g=Tt(h,r.box_predictor_4),_=Tt(d,r.box_predictor_5);return{boxPredictions:n.concat([u.boxPredictionEncoding,p.boxPredictionEncoding,f.boxPredictionEncoding,m.boxPredictionEncoding,g.boxPredictionEncoding,_.boxPredictionEncoding],1),classPredictions:n.concat([u.classPrediction,p.classPrediction,f.classPrediction,m.classPrediction,g.classPrediction,_.classPrediction],1)}}))}var z=class{constructor({minConfidence:e,maxResults:t}={}){if(this._name="SsdMobilenetv1Options",this._minConfidence=e||.5,this._maxResults=t||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw new Error(`${this._name} - expected minConfidence to be a number between 0 and 1`);if("number"!=typeof this._maxResults)throw new Error(`${this._name} - expected maxResults to be a number`)}get minConfidence(){return this._minConfidence}get maxResults(){return this._maxResults}},wt=class extends I{constructor(){super("SsdMobilenetv1")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("SsdMobilenetv1 - load model before inference");return n.tidy((()=>{let r=n.cast(e.toBatchTensor(512,!1),"float32"),a=Zr(n.sub(n.div(r,127.5),1),t.mobilenetv1),{boxPredictions:i,classPredictions:o}=to(a.out,a.conv11,t.prediction_layer);return Qr(i,o,t.output_layer)}))}async forward(e){return this.forwardInput(await M(e))}async locateFaces(e,t={}){let{maxResults:n,minConfidence:r}=new z(t),a=await M(e),{boxes:i,scores:o}=this.forwardInput(a),s=i[0],c=o[0];for(let e=1;e<i.length;e++)i[e].dispose(),o[e].dispose();let h=Array.from(c.dataSync()),l=Kr(s,h,n,.5,r),d=a.getReshapedInputDimensions(0),u=a.inputSize,p=u/d.width,f=u/d.height,m=s.arraySync(),g=l.map((e=>{let[t,n]=[Math.max(0,m[e][0]),Math.min(1,m[e][2])].map((e=>e*f)),[r,i]=[Math.max(0,m[e][1]),Math.min(1,m[e][3])].map((e=>e*p));return new E(h[e],new St(r,t,i-r,n-t),{height:a.getInputHeight(0),width:a.getInputWidth(0)})}));return s.dispose(),c.dispose(),g}getDefaultModelName(){return"ssd_mobilenetv1_model"}extractParamsFromWeightMap(e){return qr(e)}extractParams(e){return Jr(e)}};function qo(e){let t=new wt;return t.extractWeights(e),t}function bl(e){return qo(e)}var eo=class extends wt{},ro=.4,oo=[new g(.738768,.874946),new g(2.42204,2.65704),new g(4.30971,7.04493),new g(10.246,4.59428),new g(12.6868,11.8741)],no=[new g(1.603231,2.094468),new g(6.041143,7.080126),new g(2.882459,3.518061),new g(4.266906,5.178857),new g(9.041765,10.66308)],ao=[117.001,114.697,97.404],so="tiny_yolov2_model",io="tiny_yolov2_separable_conv_model",Se=e=>"number"==typeof e;function co(e){if(!e)throw new Error(`invalid config: ${e}`);if("boolean"!=typeof e.withSeparableConvs)throw new Error(`config.withSeparableConvs has to be a boolean, have: ${e.withSeparableConvs}`);if(!Se(e.iouThreshold)||e.iouThreshold<0||e.iouThreshold>1)throw new Error(`config.iouThreshold has to be a number between [0, 1], have: ${e.iouThreshold}`);if(!Array.isArray(e.classes)||!e.classes.length||!e.classes.every((e=>"string"==typeof e)))throw new Error(`config.classes has to be an array class names: string[], have: ${JSON.stringify(e.classes)}`);if(!Array.isArray(e.anchors)||!e.anchors.length||!e.anchors.map((e=>e||{})).every((e=>Se(e.x)&&Se(e.y))))throw new Error(`config.anchors has to be an array of { x: number, y: number }, have: ${JSON.stringify(e.anchors)}`);if(e.meanRgb&&(!Array.isArray(e.meanRgb)||3!==e.meanRgb.length||!e.meanRgb.every(Se)))throw new Error(`config.meanRgb has to be an array of shape [number, number, number], have: ${JSON.stringify(e.meanRgb)}`)}function Xt(e){return n.tidy((()=>{let t=n.mul(e,n.scalar(.10000000149011612));return n.add(n.relu(n.sub(e,t)),t)}))}function ot(e,t){return n.tidy((()=>{let r=n.pad(e,[[0,0],[1,1],[1,1],[0,0]]);return r=n.conv2d(r,t.conv.filters,[1,1],"valid"),r=n.sub(r,t.bn.sub),r=n.mul(r,t.bn.truediv),r=n.add(r,t.conv.bias),Xt(r)}))}function nt(e,t){return n.tidy((()=>{let r=n.pad(e,[[0,0],[1,1],[1,1],[0,0]]);return r=n.separableConv2d(r,t.depthwise_filter,t.pointwise_filter,[1,1],"valid"),r=n.add(r,t.bias),Xt(r)}))}function Zo(e,t){let r=$t(e,t),a=Ot(e,t);return{extractConvParams:r,extractConvWithBatchNormParams:function(a,i,o){let s=r(a,i,3,`${o}/conv`),c=function(r,a){let i=n.tensor1d(e(r)),o=n.tensor1d(e(r));return t.push({paramPath:`${a}/sub`},{paramPath:`${a}/truediv`}),{sub:i,truediv:o}}(i,`${o}/bn`);return{conv:s,bn:c}},extractSeparableConvParams:a}}function mo(e,t,n,r){let a,{extractWeights:i,getRemainingWeights:o}=A(e),s=[],{extractConvParams:c,extractConvWithBatchNormParams:h,extractSeparableConvParams:l}=Zo(i,s);if(t.withSeparableConvs){let[e,i,o,s,h,d,u,p,f]=r;a={conv0:t.isFirstLayerConv2d?c(e,i,3,"conv0"):l(e,i,"conv0"),conv1:l(i,o,"conv1"),conv2:l(o,s,"conv2"),conv3:l(s,h,"conv3"),conv4:l(h,d,"conv4"),conv5:l(d,u,"conv5"),conv6:p?l(u,p,"conv6"):void 0,conv7:f?l(p,f,"conv7"):void 0,conv8:c(f||p||u,5*n,1,"conv8")}}else{let[e,t,i,o,s,l,d,u,p]=r;a={conv0:h(e,t,"conv0"),conv1:h(t,i,"conv1"),conv2:h(i,o,"conv2"),conv3:h(o,s,"conv3"),conv4:h(s,l,"conv4"),conv5:h(l,d,"conv5"),conv6:h(d,u,"conv6"),conv7:h(u,p,"conv7"),conv8:c(p,5*n,1,"conv8")}}if(0!==o().length)throw new Error(`weights remaing after extract: ${o().length}`);return{params:a,paramMappings:s}}function Ko(e,t){let n=B(e,t);function r(e){return{filters:n(`${e}/filters`,4),bias:n(`${e}/bias`,1)}}return{extractConvParams:r,extractConvWithBatchNormParams:function(e){let t=r(`${e}/conv`),a=function(e){return{sub:n(`${e}/sub`,1),truediv:n(`${e}/truediv`,1)}}(`${e}/bn`);return{conv:t,bn:a}},extractSeparableConvParams:Ht(n)}}function po(e,t){let n,r=[],{extractConvParams:a,extractConvWithBatchNormParams:i,extractSeparableConvParams:o}=Ko(e,r);if(t.withSeparableConvs){let e=t.filterSizes&&t.filterSizes.length||9;n={conv0:t.isFirstLayerConv2d?a("conv0"):o("conv0"),conv1:o("conv1"),conv2:o("conv2"),conv3:o("conv3"),conv4:o("conv4"),conv5:o("conv5"),conv6:e>7?o("conv6"):void 0,conv7:e>8?o("conv7"):void 0,conv8:a("conv8")}}else n={conv0:i("conv0"),conv1:i("conv1"),conv2:i("conv2"),conv3:i("conv3"),conv4:i("conv4"),conv5:i("conv5"),conv6:i("conv6"),conv7:i("conv7"),conv8:a("conv8")};return L(e,r),{params:n,paramMappings:r}}var J=class{constructor({inputSize:e,scoreThreshold:t}={}){if(this._name="TinyYolov2Options",this._inputSize=e||416,this._scoreThreshold=t||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(`${this._name} - expected inputSize to be a number divisible by 32`);if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(`${this._name} - expected scoreThreshold to be a number between 0 and 1`)}get inputSize(){return this._inputSize}get scoreThreshold(){return this._scoreThreshold}},cr=class extends I{constructor(e){super("TinyYolov2"),co(e),this._config=e}get config(){return this._config}get withClassScores(){return this.config.withClassScores||this.config.classes.length>1}get boxEncodingSize(){return 5+(this.withClassScores?this.config.classes.length:0)}runTinyYolov2(e,t){let r=ot(e,t.conv0);return r=n.maxPool(r,[2,2],[2,2],"same"),r=ot(r,t.conv1),r=n.maxPool(r,[2,2],[2,2],"same"),r=ot(r,t.conv2),r=n.maxPool(r,[2,2],[2,2],"same"),r=ot(r,t.conv3),r=n.maxPool(r,[2,2],[2,2],"same"),r=ot(r,t.conv4),r=n.maxPool(r,[2,2],[2,2],"same"),r=ot(r,t.conv5),r=n.maxPool(r,[2,2],[1,1],"same"),r=ot(r,t.conv6),r=ot(r,t.conv7),_t(r,t.conv8,"valid",!1)}runMobilenet(e,t){let r=this.config.isFirstLayerConv2d?Xt(_t(e,t.conv0,"valid",!1)):nt(e,t.conv0);return r=n.maxPool(r,[2,2],[2,2],"same"),r=nt(r,t.conv1),r=n.maxPool(r,[2,2],[2,2],"same"),r=nt(r,t.conv2),r=n.maxPool(r,[2,2],[2,2],"same"),r=nt(r,t.conv3),r=n.maxPool(r,[2,2],[2,2],"same"),r=nt(r,t.conv4),r=n.maxPool(r,[2,2],[2,2],"same"),r=nt(r,t.conv5),r=n.maxPool(r,[2,2],[1,1],"same"),r=t.conv6?nt(r,t.conv6):r,r=t.conv7?nt(r,t.conv7):r,_t(r,t.conv8,"valid",!1)}forwardInput(e,t){let{params:r}=this;if(!r)throw new Error("TinyYolov2 - load model before inference");return n.tidy((()=>{let a=n.cast(e.toBatchTensor(t,!1),"float32");return a=this.config.meanRgb?X(a,this.config.meanRgb):a,a=a.div(255),this.config.withSeparableConvs?this.runMobilenet(a,r):this.runTinyYolov2(a,r)}))}async forward(e,t){return this.forwardInput(await M(e),t)}async detect(e,t={}){let{inputSize:r,scoreThreshold:a}=new J(t),i=await M(e),o=await this.forwardInput(i,r),s=n.tidy((()=>n.unstack(o)[0].expandDims())),c={width:i.getInputWidth(0),height:i.getInputHeight(0)},h=await this.extractBoxes(s,i.getReshapedInputDimensions(0),a);o.dispose(),s.dispose();let l=h.map((e=>e.box)),d=h.map((e=>e.score)),u=h.map((e=>e.classScore)),p=h.map((e=>this.config.classes[e.label]));return xr(l.map((e=>e.rescale(r))),d,this.config.iouThreshold,!0).map((e=>new ct(d[e],u[e],p[e],l[e],c)))}getDefaultModelName(){return""}extractParamsFromWeightMap(e){return po(e,this.config)}extractParams(e){let t=this.config.filterSizes||cr.DEFAULT_FILTER_SIZES,n=t?t.length:void 0;if(7!==n&&8!==n&&9!==n)throw new Error(`TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found ${n} filterSizes in config`);return mo(e,this.config,this.boxEncodingSize,t)}async extractBoxes(e,t,r){let{width:a,height:i}=t,o=Math.max(a,i),s=o/a,c=o/i,h=e.shape[1],l=this.config.anchors.length,[d,u,p]=n.tidy((()=>{let t=e.reshape([h,h,l,this.boxEncodingSize]);return[t.slice([0,0,0,0],[h,h,l,4]),t.slice([0,0,0,4],[h,h,l,1]),this.withClassScores?n.softmax(t.slice([0,0,0,5],[h,h,l,this.config.classes.length]),3):n.scalar(0)]})),f=[],m=await u.array(),g=await d.array();for(let e=0;e<h;e++)for(let t=0;t<h;t++)for(let n=0;n<l;n++){let a=fe(m[e][t][n][0]);if(!r||a>r){let r=(t+fe(g[e][t][n][0]))/h*s,i=(e+fe(g[e][t][n][1]))/h*c,o=Math.exp(g[e][t][n][2])*this.config.anchors[n].x/h*s,l=Math.exp(g[e][t][n][3])*this.config.anchors[n].y/h*c,d=r-o/2,u=i-l/2,m={row:e,col:t,anchor:n},{classScore:_,label:w}=this.withClassScores?await this.extractPredictedClass(p,m):{classScore:1,label:0};f.push({box:new Nt(d,u,d+o,u+l),score:a,classScore:a*_,label:w,...m})}}return d.dispose(),u.dispose(),p.dispose(),f}async extractPredictedClass(e,t){let{row:n,col:r,anchor:a}=t,i=await e.array();return Array(this.config.classes.length).fill(0).map(((e,t)=>i[n][r][a][t])).map(((e,t)=>({classScore:e,label:t}))).reduce(((e,t)=>e.classScore>t.classScore?e:t))}},Pt=cr;Pt.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024];var Jt=class extends Pt{constructor(e=!0){super({withSeparableConvs:e,iouThreshold:ro,classes:["face"],...e?{anchors:no,meanRgb:ao}:{anchors:oo,withClassScores:!0}})}get withSeparableConvs(){return this.config.withSeparableConvs}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map((e=>new E(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})))}getDefaultModelName(){return this.withSeparableConvs?io:so}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}};function id(e,t=!0){let n=new Jt(t);return n.extractWeights(e),n}var Le=class extends J{constructor(){super(...arguments),this._name="TinyFaceDetectorOptions"}},V=class{async then(e){return e(await this.run())}async run(){throw new Error("ComposableTask - run is not implemented")}};async function Ft(e,t,r,a,i=(({alignedRect:e})=>e)){let o=e.map((e=>Yt(e)?i(e):e.detection)),s=a||(t instanceof n.Tensor?await oe(t,o):await re(t,o)),c=await r(s);return s.forEach((e=>e instanceof n.Tensor&&e.dispose())),c}async function qt(e,t,n,r,a){return Ft([e],t,(async e=>n(e[0])),r,a)}var uo=.4,fo=[new g(1.603231,2.094468),new g(6.041143,7.080126),new g(2.882459,3.518061),new g(4.266906,5.178857),new g(9.041765,10.66308)],lo=[117.001,114.697,97.404],Zt=class extends Pt{constructor(){super({withSeparableConvs:!0,iouThreshold:uo,classes:["face"],anchors:fo,meanRgb:lo,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map((e=>new E(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})))}getDefaultModelName(){return"tiny_face_detector_model"}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}},T={ssdMobilenetv1:new wt,tinyFaceDetector:new Zt,tinyYolov2:new Jt,faceLandmark68Net:new jt,faceLandmark68TinyNet:new Ie,faceRecognitionNet:new Ut,faceExpressionNet:new Pe,ageGenderNet:new Me},Qo=(e,t)=>T.ssdMobilenetv1.locateFaces(e,t),Bd=(e,t)=>T.tinyFaceDetector.locateFaces(e,t),Rd=(e,t)=>T.tinyYolov2.locateFaces(e,t),tn=e=>T.faceLandmark68Net.detectLandmarks(e),$d=e=>T.faceLandmark68TinyNet.detectLandmarks(e),Od=e=>T.faceRecognitionNet.computeFaceDescriptor(e),Hd=e=>T.faceExpressionNet.predictExpressions(e),zd=e=>T.ageGenderNet.predictAgeAndGender(e),en=e=>T.ssdMobilenetv1.load(e),Vd=e=>T.tinyFaceDetector.load(e),Yd=e=>T.tinyYolov2.load(e),Gd=e=>T.faceLandmark68Net.load(e),jd=e=>T.faceLandmark68TinyNet.load(e),Ud=e=>T.faceRecognitionNet.load(e),Xd=e=>T.faceExpressionNet.load(e),Jd=e=>T.ageGenderNet.load(e),qd=en,Zd=Qo,Kd=tn,Ae=class extends V{constructor(e,t,n){super(),this.parentTask=e,this.input=t,this.extractedFaces=n}},Dt=class extends Ae{async run(){let e=await this.parentTask,t=await Ft(e,this.input,(async e=>Promise.all(e.map((e=>T.faceExpressionNet.predictExpressions(e))))),this.extractedFaces);return e.map(((e,n)=>tr(e,t[n])))}withAgeAndGender(){return new Mt(this,this.input)}},Et=class extends Ae{async run(){let e=await this.parentTask;if(e)return tr(e,await qt(e,this.input,(e=>T.faceExpressionNet.predictExpressions(e)),this.extractedFaces))}withAgeAndGender(){return new Ct(this,this.input)}},ut=class extends Dt{withAgeAndGender(){return new lt(this,this.input)}withFaceDescriptors(){return new ht(this,this.input)}},ft=class extends Et{withAgeAndGender(){return new dt(this,this.input)}withFaceDescriptor(){return new bt(this,this.input)}},We=class extends V{constructor(e,t,n){super(),this.parentTask=e,this.input=t,this.extractedFaces=n}},Mt=class extends We{async run(){let e=await this.parentTask,t=await Ft(e,this.input,(async e=>Promise.all(e.map((e=>T.ageGenderNet.predictAgeAndGender(e))))),this.extractedFaces);return e.map(((e,n)=>{let{age:r,gender:a,genderProbability:i}=t[n];return sr(ir(e,a,i),r)}))}withFaceExpressions(){return new Dt(this,this.input)}},Ct=class extends We{async run(){let e=await this.parentTask;if(!e)return;let{age:t,gender:n,genderProbability:r}=await qt(e,this.input,(e=>T.ageGenderNet.predictAgeAndGender(e)),this.extractedFaces);return sr(ir(e,n,r),t)}withFaceExpressions(){return new Et(this,this.input)}},lt=class extends Mt{withFaceExpressions(){return new ut(this,this.input)}withFaceDescriptors(){return new ht(this,this.input)}},dt=class extends Ct{withFaceExpressions(){return new ft(this,this.input)}withFaceDescriptor(){return new bt(this,this.input)}},ke=class extends V{constructor(e,t){super(),this.parentTask=e,this.input=t}},ht=class extends ke{async run(){let e=await this.parentTask;return(await Ft(e,this.input,(e=>Promise.all(e.map((e=>T.faceRecognitionNet.computeFaceDescriptor(e))))),null,(e=>e.landmarks.align(null,{useDlibAlignment:!0})))).map(((t,n)=>ar(e[n],t)))}withFaceExpressions(){return new ut(this,this.input)}withAgeAndGender(){return new lt(this,this.input)}},bt=class extends ke{async run(){let e=await this.parentTask;if(e)return ar(e,await qt(e,this.input,(e=>T.faceRecognitionNet.computeFaceDescriptor(e)),null,(e=>e.landmarks.align(null,{useDlibAlignment:!0}))))}withFaceExpressions(){return new ft(this,this.input)}withAgeAndGender(){return new dt(this,this.input)}},Be=class extends V{constructor(e,t,n){super(),this.parentTask=e,this.input=t,this.useTinyLandmarkNet=n}get landmarkNet(){return this.useTinyLandmarkNet?T.faceLandmark68TinyNet:T.faceLandmark68Net}},Re=class extends Be{async run(){let e=await this.parentTask,t=e.map((e=>e.detection)),r=this.input instanceof n.Tensor?await oe(this.input,t):await re(this.input,t),a=await Promise.all(r.map((e=>this.landmarkNet.detectLandmarks(e))));return r.forEach((e=>e instanceof n.Tensor&&e.dispose())),e.filter(((e,t)=>a[t])).map(((e,t)=>ie(e,a[t])))}withFaceExpressions(){return new ut(this,this.input)}withAgeAndGender(){return new lt(this,this.input)}withFaceDescriptors(){return new ht(this,this.input)}},$e=class extends Be{async run(){let e=await this.parentTask;if(!e)return;let{detection:t}=e,r=this.input instanceof n.Tensor?await oe(this.input,[t]):await re(this.input,[t]),a=await this.landmarkNet.detectLandmarks(r[0]);return r.forEach((e=>e instanceof n.Tensor&&e.dispose())),ie(e,a)}withFaceExpressions(){return new ft(this,this.input)}withAgeAndGender(){return new dt(this,this.input)}withFaceDescriptor(){return new bt(this,this.input)}},Oe=class extends V{constructor(e,t=new z){super(),this.input=e,this.options=t}},me=class extends Oe{async run(){let e,{input:t,options:n}=this;if(n instanceof Le)e=T.tinyFaceDetector.locateFaces(t,n);else if(n instanceof z)e=T.ssdMobilenetv1.locateFaces(t,n);else{if(!(n instanceof J))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | TinyYolov2Options");e=T.tinyYolov2.locateFaces(t,n)}return e}runAndExtendWithFaceDetections(){return new Promise(((e,t)=>{this.run().then((t=>e(t.map((e=>At({},e)))))).catch((e=>t(e)))}))}withFaceLandmarks(e=!1){return new Re(this.runAndExtendWithFaceDetections(),this.input,e)}withFaceExpressions(){return new Dt(this.runAndExtendWithFaceDetections(),this.input)}withAgeAndGender(){return new Mt(this.runAndExtendWithFaceDetections(),this.input)}},He=class extends Oe{async run(){let e=await new me(this.input,this.options),t=e[0];return e.forEach((e=>{e.score>t.score&&(t=e)})),t}runAndExtendWithFaceDetection(){return new Promise((async e=>{let t=await this.run();e(t?At({},t):void 0)}))}withFaceLandmarks(e=!1){return new $e(this.runAndExtendWithFaceDetection(),this.input,e)}withFaceExpressions(){return new Et(this.runAndExtendWithFaceDetection(),this.input)}withAgeAndGender(){return new Ct(this.runAndExtendWithFaceDetection(),this.input)}};function Jh(e,t=new z){return new He(e,t)}function mr(e,t=new z){return new me(e,t)}async function rn(e,t){return mr(e,new z(t?{minConfidence:t}:{})).withFaceLandmarks().withFaceDescriptors()}async function eb(e,t={}){return mr(e,new J(t)).withFaceLandmarks().withFaceDescriptors()}var rb=rn;function ho(e,t){if(e.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");let n=Array.from(e),r=Array.from(t);return Math.sqrt(n.map(((e,t)=>e-r[t])).reduce(((e,t)=>e+t*t),0))}var ze=class{constructor(e,t=.6){this._distanceThreshold=t;let n=Array.isArray(e)?e:[e];if(!n.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");let r=1,a=()=>"person "+r++;this._labeledDescriptors=n.map((e=>{if(e instanceof Q)return e;if(e instanceof Float32Array)return new Q(a(),[e]);if(e.descriptor&&e.descriptor instanceof Float32Array)return new Q(a(),[e.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")}))}get labeledDescriptors(){return this._labeledDescriptors}get distanceThreshold(){return this._distanceThreshold}computeMeanDistance(e,t){return t.map((t=>ho(t,e))).reduce(((e,t)=>e+t),0)/(t.length||1)}matchDescriptor(e){return this.labeledDescriptors.map((({descriptors:t,label:n})=>new Kt(n,this.computeMeanDistance(e,t)))).reduce(((e,t)=>e.distance<t.distance?e:t))}findBestMatch(e){let t=this.matchDescriptor(e);return t.distance<this._distanceThreshold?t:new Kt("unknown",t.distance)}toJSON(){return{distanceThreshold:this._distanceThreshold,labeledDescriptors:this._labeledDescriptors.map((e=>e.toJSON()))}}static fromJSON(e){let t=e.labeledDescriptors.map((e=>Q.fromJSON(e)));return new ze(t,e.distanceThreshold)}};function yb(e){let t=new Zt;return t.extractWeights(e),t}function on(e,t){let{width:n,height:r}=new S(t.width,t.height);if(n<=0||r<=0)throw new Error(`resizeResults - invalid dimensions: ${JSON.stringify({width:n,height:r})}`);if(Array.isArray(e))return e.map((e=>on(e,{width:n,height:r})));if(Yt(e)){let t=e.detection.forSize(n,r),a=e.unshiftedLandmarks.forSize(t.box.width,t.box.height);return ie(At(e,t),a)}return tt(e)?At(e,e.detection.forSize(n,r)):e instanceof $||e instanceof E?e.forSize(n,r):e}var Nb=kr;export{Me as AgeGenderNet,Nt as BoundingBox,F as Box,V as ComposableTask,ht as ComputeAllFaceDescriptorsTask,ke as ComputeFaceDescriptorsTaskBase,bt as ComputeSingleFaceDescriptorTask,Re as DetectAllFaceLandmarksTask,me as DetectAllFacesTask,Be as DetectFaceLandmarksTaskBase,Oe as DetectFacesTaskBase,$e as DetectSingleFaceLandmarksTask,He as DetectSingleFaceTask,S as Dimensions,Lr as FACE_EXPRESSION_LABELS,E as FaceDetection,eo as FaceDetectionNet,Pe as FaceExpressionNet,pt as FaceExpressions,jt as FaceLandmark68Net,Ie as FaceLandmark68TinyNet,Yr as FaceLandmarkNet,$ as FaceLandmarks,yr as FaceLandmarks5,Lt as FaceLandmarks68,Kt as FaceMatch,ze as FaceMatcher,Ut as FaceRecognitionNet,rr as Gender,Qt as LabeledBox,Q as LabeledFaceDescriptors,rt as NetInput,I as NeuralNetwork,ct as ObjectDetection,g as Point,_r as PredictedBox,St as Rect,wt as SsdMobilenetv1,z as SsdMobilenetv1Options,Zt as TinyFaceDetector,Le as TinyFaceDetectorOptions,Jt as TinyYolov2,J as TinyYolov2Options,rb as allFaces,rn as allFacesSsdMobilenetv1,eb as allFacesTinyYolov2,Tr as awaitMediaLoaded,wr as bufferToImage,Od as computeFaceDescriptor,Rt as createCanvas,be as createCanvasFromMedia,bl as createFaceDetectionNet,bf as createFaceRecognitionNet,qo as createSsdMobilenetv1,yb as createTinyFaceDetector,id as createTinyYolov2,mr as detectAllFaces,tn as detectFaceLandmarks,$d as detectFaceLandmarksTiny,Kd as detectLandmarks,Jh as detectSingleFace,Wr as draw,_ as env,ho as euclideanDistance,sr as extendWithAge,ar as extendWithFaceDescriptor,At as extendWithFaceDetection,tr as extendWithFaceExpressions,ie as extendWithFaceLandmarks,ir as extendWithGender,oe as extractFaceTensors,re as extractFaces,Fi as fetchImage,Dr as fetchJson,Ii as fetchNetWeights,mt as fetchOrThrow,ki as fetchVideo,k as getContext2dOrThrow,Bt as getMediaDimensions,Pr as imageTensorToCanvas,Fr as imageToSquare,On as inverseSigmoid,br as iou,Qe as isMediaElement,he as isMediaLoaded,yf as isWithAge,tt as isWithFaceDetection,Ar as isWithFaceExpressions,Yt as isWithFaceLandmarks,Pf as isWithGender,Jd as loadAgeGenderModel,qd as loadFaceDetectionModel,Xd as loadFaceExpressionModel,Gd as loadFaceLandmarkModel,jd as loadFaceLandmarkTinyModel,Ud as loadFaceRecognitionModel,en as loadSsdMobilenetv1Model,Vd as loadTinyFaceDetectorModel,Yd as loadTinyYolov2Model,Mr as loadWeightMap,Zd as locateFaces,Vi as matchDimensions,gr as minBbox,T as nets,xr as nonMaxSuppression,X as normalize,vr as padToSquare,zd as predictAgeAndGender,Hd as recognizeFaceExpressions,on as resizeResults,Wt as resolveInput,Rn as shuffleArray,fe as sigmoid,Qo as ssdMobilenetv1,n as tf,Bd as tinyFaceDetector,Rd as tinyYolov2,M as toNetInput,hr as utils,co as validateConfig,Nb as version};