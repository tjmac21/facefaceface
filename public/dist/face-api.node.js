"use strict";var dn=Object.create,er=Object.defineProperty,hn=Object.getOwnPropertyDescriptor,bn=Object.getOwnPropertyNames,gn=Object.getPrototypeOf,xn=Object.prototype.hasOwnProperty,vn=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Lr=(e,t)=>{for(var r in t)er(e,r,{get:t[r],enumerable:!0})},To=(e,t,r,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let a of bn(t))!xn.call(e,a)&&a!==r&&er(e,a,{get:()=>t[a],enumerable:!(n=hn(t,a))||n.enumerable});return e},v=(e,t,r)=>(r=null!=e?dn(gn(e)):{},To(!t&&e&&e.__esModule?r:er(r,"default",{value:e,enumerable:!0}),e)),yn=e=>To(er({},"__esModule",{value:!0}),e),x=vn(((e,t)=>{var r,n=Object.defineProperty,a=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,o=Object.prototype.hasOwnProperty,s=(e,t,r,s)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let c of i(t))!o.call(e,c)&&c!==r&&n(e,c,{get:()=>t[c],enumerable:!(s=a(t,c))||s.enumerable});return e},c={};((e,t)=>{for(var r in t)n(e,r,{get:t[r],enumerable:!0})})(c,{version:()=>l}),t.exports=(r=c,s(n({},"__esModule",{value:!0}),r)),((e,t,r)=>{s(e,t,"default"),r&&s(r,t,"default")})(c,require("@tensorflow/tfjs-node"),t.exports);var h="4.1.0",l={tfjs:h,"tfjs-core":h,"tfjs-converter":"4.1.0","tfjs-backend-cpu":"4.1.0","tfjs-backend-webgl":"4.1.0","tfjs-backend-wasm":"4.1.0"}})),Ra={};Lr(Ra,{AgeGenderNet:()=>He,BoundingBox:()=>Vt,Box:()=>D,ComposableTask:()=>J,ComputeAllFaceDescriptorsTask:()=>Pt,ComputeFaceDescriptorsTaskBase:()=>Ue,ComputeSingleFaceDescriptorTask:()=>Ft,DetectAllFaceLandmarksTask:()=>qe,DetectAllFacesTask:()=>Ie,DetectFaceLandmarksTaskBase:()=>Je,DetectFacesTaskBase:()=>Ke,DetectSingleFaceLandmarksTask:()=>Ze,DetectSingleFaceTask:()=>Qe,Dimensions:()=>k,FACE_EXPRESSION_LABELS:()=>so,FaceDetection:()=>M,FaceDetectionNet:()=>lo,FaceExpressionNet:()=>Oe,FaceExpressions:()=>yt,FaceLandmark68Net:()=>Kt,FaceLandmark68TinyNet:()=>ze,FaceLandmarkNet:()=>po,FaceLandmarks:()=>z,FaceLandmarks5:()=>jr,FaceLandmarks68:()=>Gt,FaceMatch:()=>pe,FaceMatcher:()=>tr,FaceRecognitionNet:()=>Qt,Gender:()=>Tr,LabeledBox:()=>ue,LabeledFaceDescriptors:()=>mt,NetInput:()=>ut,NeuralNetwork:()=>A,ObjectDetection:()=>bt,Point:()=>g,PredictedBox:()=>Ur,Rect:()=>Yt,SsdMobilenetv1:()=>St,SsdMobilenetv1Options:()=>X,TinyFaceDetector:()=>ne,TinyFaceDetectorOptions:()=>je,TinyYolov2:()=>re,TinyYolov2Options:()=>st,allFaces:()=>Aa,allFacesSsdMobilenetv1:()=>fn,allFacesTinyYolov2:()=>La,awaitMediaLoaded:()=>to,bufferToImage:()=>eo,computeFaceDescriptor:()=>va,createCanvas:()=>Jt,createCanvasFromMedia:()=>We,createFaceDetectionNet:()=>fa,createFaceRecognitionNet:()=>ea,createSsdMobilenetv1:()=>qo,createTinyFaceDetector:()=>Wa,createTinyYolov2:()=>ha,detectAllFaces:()=>Sr,detectFaceLandmarks:()=>pn,detectFaceLandmarksTiny:()=>xa,detectLandmarks:()=>Na,detectSingleFace:()=>Sa,draw:()=>co,env:()=>w,euclideanDistance:()=>vo,extendWithAge:()=>Er,extendWithFaceDescriptor:()=>Dr,extendWithFaceDetection:()=>jt,extendWithFaceExpressions:()=>xr,extendWithFaceLandmarks:()=>Pe,extendWithGender:()=>Mr,extractFaceTensors:()=>de,extractFaces:()=>le,fetchImage:()=>Hn,fetchJson:()=>no,fetchNetWeights:()=>zn,fetchOrThrow:()=>xt,fetchVideo:()=>Vn,getContext2dOrThrow:()=>O,getMediaDimensions:()=>Xt,imageTensorToCanvas:()=>ro,imageToSquare:()=>oo,inverseSigmoid:()=>An,iou:()=>zr,isMediaElement:()=>ir,isMediaLoaded:()=>Ae,isWithAge:()=>ra,isWithFaceDetection:()=>pt,isWithFaceExpressions:()=>io,isWithFaceLandmarks:()=>Zt,isWithGender:()=>oa,loadAgeGenderModel:()=>Ma,loadFaceDetectionModel:()=>Ca,loadFaceExpressionModel:()=>Ea,loadFaceLandmarkModel:()=>Pa,loadFaceLandmarkTinyModel:()=>Fa,loadFaceRecognitionModel:()=>Da,loadSsdMobilenetv1Model:()=>un,loadTinyFaceDetectorModel:()=>Ta,loadTinyYolov2Model:()=>wa,loadWeightMap:()=>ao,locateFaces:()=>Ia,matchDimensions:()=>Yn,minBbox:()=>Vr,nets:()=>P,nonMaxSuppression:()=>Yr,normalize:()=>rt,padToSquare:()=>Gr,predictAgeAndGender:()=>_a,recognizeFaceExpressions:()=>ya,resizeResults:()=>ln,resolveInput:()=>Ut,shuffleArray:()=>Ln,sigmoid:()=>Ne,ssdMobilenetv1:()=>mn,tf:()=>ka,tinyFaceDetector:()=>ba,tinyYolov2:()=>ga,toNetInput:()=>C,utils:()=>Hr,validateConfig:()=>ho,version:()=>Ba}),module.exports=yn(Ra);var ka=v(x()),co={};function dt(e,t,r=!1){if(e.beginPath(),t.slice(1).forEach((({x:r,y:n},a)=>{let i=t[a];e.moveTo(i.x,i.y),e.lineTo(r,n)})),r){let r=t[t.length-1],n=t[0];if(!r||!n)return;e.moveTo(r.x,r.y),e.lineTo(n.x,n.y)}e.stroke()}Lr(co,{AnchorPosition:()=>Qr,DrawBox:()=>Le,DrawBoxOptions:()=>ar,DrawFaceLandmarks:()=>yr,DrawFaceLandmarksOptions:()=>vr,DrawTextField:()=>gt,DrawTextFieldOptions:()=>fe,drawContour:()=>dt,drawDetections:()=>On,drawFaceExpressions:()=>Gn,drawFaceLandmarks:()=>Un});var Hr={};Lr(Hr,{computeReshapedDimensions:()=>Or,getCenterPoint:()=>zt,isDimensions:()=>or,isEven:()=>rr,isFloat:()=>$r,isTensor:()=>Ot,isTensor1D:()=>Sn,isTensor2D:()=>Rr,isTensor3D:()=>ht,isTensor4D:()=>U,isValidNumber:()=>et,isValidProbablitiy:()=>me,range:()=>it,round:()=>Ht});var Po=v(x()),k=class{constructor(e,t){if(!et(e)||!et(t))throw new Error(`Dimensions.constructor - expected width and height to be valid numbers, instead have ${JSON.stringify({width:e,height:t})}`);this._width=e,this._height=t}get width(){return this._width}get height(){return this._height}reverse(){return new k(1/this.width,1/this.height)}};function Ot(e,t){return e instanceof Po.Tensor&&e.shape.length===t}function Sn(e){return Ot(e,1)}function Rr(e){return Ot(e,2)}function ht(e){return Ot(e,3)}function U(e){return Ot(e,4)}function $r(e){return e%1!=0}function rr(e){return e%2==0}function Ht(e,t=2){let r=10**t;return Math.floor(e*r)/r}function or(e){return e&&e.width&&e.height}function Or({width:e,height:t},r){let n=r/Math.max(t,e);return new k(Math.round(e*n),Math.round(t*n))}function zt(e){return e.reduce(((e,t)=>e.add(t)),new g(0,0)).div(new g(e.length,e.length))}function it(e,t,r){return Array(e).fill(0).map(((e,n)=>t+n*r))}function et(e){return!!e&&e!==1/0&&e!==-1/0&&!Number.isNaN(e)||0===e}function me(e){return et(e)&&e>=0&&e<=1}var g=class{constructor(e,t){this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}add(e){return new g(this.x+e.x,this.y+e.y)}sub(e){return new g(this.x-e.x,this.y-e.y)}mul(e){return new g(this.x*e.x,this.y*e.y)}div(e){return new g(this.x/e.x,this.y/e.y)}abs(){return new g(Math.abs(this.x),Math.abs(this.y))}magnitude(){return Math.sqrt(this.x**2+this.y**2)}floor(){return new g(Math.floor(this.x),Math.floor(this.y))}},D=class{static isRect(e){return!!e&&[e.x,e.y,e.width,e.height].every(et)}static assertIsValidBox(e,t,r=!1){if(!D.isRect(e))throw new Error(`${t} - invalid box: ${JSON.stringify(e)}, expected object with properties x, y, width, height`);if(!r&&(e.width<0||e.height<0))throw new Error(`${t} - width (${e.width}) and height (${e.height}) must be positive numbers`)}constructor(e,t=!0){let r=e||{},n=[r.left,r.top,r.right,r.bottom].every(et),a=[r.x,r.y,r.width,r.height].every(et);if(!a&&!n)throw new Error(`Box.constructor - expected box to be IBoundingBox | IRect, instead have ${JSON.stringify(r)}`);let[i,o,s,c]=a?[r.x,r.y,r.width,r.height]:[r.left,r.top,r.right-r.left,r.bottom-r.top];D.assertIsValidBox({x:i,y:o,width:s,height:c},"Box.constructor",t),this._x=i,this._y=o,this._width=s,this._height=c}get x(){return this._x}get y(){return this._y}get width(){return this._width}get height(){return this._height}get left(){return this.x}get top(){return this.y}get right(){return this.x+this.width}get bottom(){return this.y+this.height}get area(){return this.width*this.height}get topLeft(){return new g(this.left,this.top)}get topRight(){return new g(this.right,this.top)}get bottomLeft(){return new g(this.left,this.bottom)}get bottomRight(){return new g(this.right,this.bottom)}round(){let[e,t,r,n]=[this.x,this.y,this.width,this.height].map((e=>Math.round(e)));return new D({x:e,y:t,width:r,height:n})}floor(){let[e,t,r,n]=[this.x,this.y,this.width,this.height].map((e=>Math.floor(e)));return new D({x:e,y:t,width:r,height:n})}toSquare(){let{x:e,y:t,width:r,height:n}=this,a=Math.abs(r-n);return r<n&&(e-=a/2,r+=a),n<r&&(t-=a/2,n+=a),new D({x:e,y:t,width:r,height:n})}rescale(e){let t=or(e)?e.width:e,r=or(e)?e.height:e;return new D({x:this.x*t,y:this.y*r,width:this.width*t,height:this.height*r})}pad(e,t){let[r,n,a,i]=[this.x-e/2,this.y-t/2,this.width+e,this.height+t];return new D({x:r,y:n,width:a,height:i})}clipAtImageBorders(e,t){let{x:r,y:n,right:a,bottom:i}=this,o=Math.max(r,0),s=Math.max(n,0),c=a-o,h=i-s,l=Math.min(c,e-o),d=Math.min(h,t-s);return new D({x:o,y:s,width:l,height:d}).floor()}shift(e,t){let{width:r,height:n}=this,a=this.x+e,i=this.y+t;return new D({x:a,y:i,width:r,height:n})}padAtBorders(e,t){let r=this.width+1,n=this.height+1,a=r,i=n,o=this.left,s=this.top,c=this.right,h=this.bottom;return c>t&&(a=-c+t+r,c=t),h>e&&(i=-h+e+n,h=e),o<1&&(i=2-o,o=1),s<1&&(i=2-s,s=1),{dy:1,edy:i,dx:1,edx:a,y:s,ey:h,x:o,ex:c,w:r,h:n}}calibrate(e){return new D({left:this.left+e.left*this.width,top:this.top+e.top*this.height,right:this.right+e.right*this.width,bottom:this.bottom+e.bottom*this.height}).toSquare().round()}},Vt=class extends D{constructor(e,t,r,n,a=!1){super({left:e,top:t,right:r,bottom:n},a)}},bt=class{constructor(e,t,r,n,a){this._imageDims=new k(a.width,a.height),this._score=e,this._classScore=t,this._className=r,this._box=new D(n).rescale(this._imageDims)}get score(){return this._score}get classScore(){return this._classScore}get className(){return this._className}get box(){return this._box}get imageDims(){return this._imageDims}get imageWidth(){return this.imageDims.width}get imageHeight(){return this.imageDims.height}get relativeBox(){return new D(this._box).rescale(this.imageDims.reverse())}forSize(e,t){return new bt(this.score,this.classScore,this.className,this.relativeBox,{width:e,height:t})}},M=class extends bt{constructor(e,t,r){super(e,e,"",t,r)}forSize(e,t){let{score:r,relativeBox:n,imageDims:a}=super.forSize(e,t);return new M(r,n,a)}};function zr(e,t,r=!0){let n=Math.max(0,Math.min(e.right,t.right)-Math.max(e.left,t.left))*Math.max(0,Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top));return r?n/(e.area+t.area-n):n/Math.min(e.area,t.area)}function Vr(e){let t=e.map((e=>e.x)),r=e.map((e=>e.y)),n=t.reduce(((e,t)=>t<e?t:e),1/0),a=r.reduce(((e,t)=>t<e?t:e),1/0),i=t.reduce(((e,t)=>e<t?t:e),0),o=r.reduce(((e,t)=>e<t?t:e),0);return new Vt(n,a,i,o)}function Yr(e,t,r,n=!0){let a=t.map(((e,t)=>({score:e,boxIndex:t}))).sort(((e,t)=>e.score-t.score)).map((e=>e.boxIndex)),i=[];for(;a.length>0;){let t=a.pop();i.push(t);let o=a,s=[];for(let r=0;r<o.length;r++){let a=o[r],i=e[t],c=e[a];s.push(zr(i,c,n))}a=a.filter(((e,t)=>s[t]<=r))}return i}var ct=v(x());function rt(e,t){return ct.tidy((()=>{let[r,n,a]=t,i=ct.fill([...e.shape.slice(0,3),1],r,"float32"),o=ct.fill([...e.shape.slice(0,3),1],n,"float32"),s=ct.fill([...e.shape.slice(0,3),1],a,"float32"),c=ct.concat([i,o,s],3);return ct.sub(e,c)}))}var Ct=v(x());function Gr(e,t=!1){return Ct.tidy((()=>{let[r,n]=e.shape.slice(1);if(r===n)return e;let a=Math.abs(r-n),i=Math.round(a*(t?.5:1)),o=r>n?2:1,s=t=>{let r=e.shape.slice();return r[o]=t,Ct.fill(r,0,"float32")},c=s(i),h=a-c.shape[o],l=[t&&h?s(h):null,e,c].filter((e=>!!e)).map((e=>Ct.cast(e,"float32")));return Ct.concat(l,o)}))}function Ln(e){let t=e.slice();for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[r],t[r]=n}return t}function Ne(e){return 1/(1+Math.exp(-e))}function An(e){return Math.log(e/(1-e))}var L,Yt=class extends D{constructor(e,t,r,n,a=!1){super({x:e,y:t,width:r,height:n},a)}},Wn=.5,kn=.43,Bn=.45,z=class{constructor(e,t,r=new g(0,0)){let{width:n,height:a}=t;this._imgDims=new k(n,a),this._shift=r,this._positions=e.map((e=>e.mul(new g(n,a)).add(r)))}get shift(){return new g(this._shift.x,this._shift.y)}get imageWidth(){return this._imgDims.width}get imageHeight(){return this._imgDims.height}get positions(){return this._positions}get relativePositions(){return this._positions.map((e=>e.sub(this._shift).div(new g(this.imageWidth,this.imageHeight))))}forSize(e,t){return new this.constructor(this.relativePositions,{width:e,height:t})}shiftBy(e,t){return new this.constructor(this.relativePositions,this._imgDims,new g(e,t))}shiftByPoint(e){return this.shiftBy(e.x,e.y)}align(e,t={}){if(e){let r=e instanceof M?e.box.floor():new D(e);return this.shiftBy(r.x,r.y).align(null,t)}let{useDlibAlignment:r,minBoxPadding:n}={useDlibAlignment:!1,minBoxPadding:.2,...t};return r?this.alignDlib():this.alignMinBbox(n)}alignDlib(){let e=this.getRefPointsForAlignment(),[t,r,n]=e,a=e=>n.sub(e).magnitude(),i=(a(t)+a(r))/2,o=Math.floor(i/Bn),s=zt(e),c=Math.floor(Math.max(0,s.x-Wn*o)),h=Math.floor(Math.max(0,s.y-kn*o));return new Yt(c,h,Math.min(o,this.imageWidth+c),Math.min(o,this.imageHeight+h))}alignMinBbox(e){let t=Vr(this.positions);return t.pad(t.width*e,t.height*e)}getRefPointsForAlignment(){throw new Error("getRefPointsForAlignment not implemented by base class")}},jr=class extends z{getRefPointsForAlignment(){let e=this.positions;return[e[0],e[1],zt([e[3],e[4]])]}},Gt=class extends z{getJawOutline(){return this.positions.slice(0,17)}getLeftEyeBrow(){return this.positions.slice(17,22)}getRightEyeBrow(){return this.positions.slice(22,27)}getNose(){return this.positions.slice(27,36)}getLeftEye(){return this.positions.slice(36,42)}getRightEye(){return this.positions.slice(42,48)}getMouth(){return this.positions.slice(48,68)}getRefPointsForAlignment(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(zt)}},pe=class{constructor(e,t){this._label=e,this._distance=t}get label(){return this._label}get distance(){return this._distance}toString(e=!0){return`${this.label}${e?` (${Ht(this.distance)})`:""}`}},ue=class extends D{constructor(e,t){super(e),this._label=t}static assertIsValidLabeledBox(e,t){if(D.assertIsValidBox(e,t),!et(e.label))throw new Error(`${t} - expected property label (${e.label}) to be a number`)}get label(){return this._label}},mt=class{constructor(e,t){if("string"!=typeof e)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(t)||t.some((e=>!(e instanceof Float32Array))))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=e,this._descriptors=t}get label(){return this._label}get descriptors(){return this._descriptors}toJSON(){return{label:this.label,descriptors:this.descriptors.map((e=>Array.from(e)))}}static fromJSON(e){let t=e.descriptors.map((e=>new Float32Array(e)));return new mt(e.label,t)}},Ur=class extends ue{constructor(e,t,r,n){super(e,t),this._score=r,this._classScore=n}static assertIsValidPredictedBox(e,t){if(ue.assertIsValidLabeledBox(e,t),!me(e.score)||!me(e.classScore))throw new Error(`${t} - expected properties score (${e.score}) and (${e.classScore}) to be a number between [0, 1]`)}get score(){return this._score}get classScore(){return this._classScore}};function pt(e){return e.detection instanceof M}function jt(e,t){return{...e,detection:t}}function Xr(){let e=window.fetch;if(!e)throw new Error("fetch - missing fetch implementation for browser environment");return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:()=>document.createElement("canvas"),createImageElement:()=>document.createElement("img"),createVideoElement:()=>document.createElement("video"),fetch:e,readFile:()=>{throw new Error("readFile - filesystem not available for browser environment")}}}function Se(){return"object"==typeof global&&"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node}function nr(e){let t="";if(!e&&Se())try{e=require("fs")}catch(e){t=e.toString()}return{readFile:e?t=>new Promise(((r,n)=>{e.readFile(t,((e,t)=>e?n(e):r(t)))})):()=>{throw new Error(`readFile - failed to require fs in nodejs environment with error: ${t}`)}}}function Jr(){let e=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,r=global.Video||global.HTMLVideoElement,n=global.fetch,a=nr();return{Canvas:e||class{},CanvasRenderingContext2D:global.CanvasRenderingContext2D||class{},Image:t||class{},ImageData:global.ImageData||class{},Video:global.HTMLVideoElement||class{},createCanvasElement:()=>{if(e)return new e;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:()=>{if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},createVideoElement:()=>{if(r)return new r;throw new Error("createVideoElement - missing Video implementation for nodejs environment")},fetch:n,...a}}function qr(){return"object"==typeof window&&"undefined"!=typeof document&&"undefined"!=typeof HTMLImageElement&&"undefined"!=typeof HTMLCanvasElement&&"undefined"!=typeof HTMLVideoElement&&"undefined"!=typeof ImageData&&"undefined"!=typeof CanvasRenderingContext2D}function Rn(){if(!L)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return L}function Zr(e){L=e}function Kr(){return qr()?Zr(Xr()):Se()?Zr(Jr()):null}function $n(e){if(L||Kr(),!L)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");let{Canvas:t=L.Canvas,Image:r=L.Image}=e;L.Canvas=t,L.Image=r,L.createCanvasElement=e.createCanvasElement||(()=>new t),L.createImageElement=e.createImageElement||(()=>new r),L.ImageData=e.ImageData||L.ImageData,L.Video=e.Video||L.Video,L.fetch=e.fetch||L.fetch,L.readFile=e.readFile||L.readFile}var w={getEnv:Rn,setEnv:Zr,initialize:Kr,createBrowserEnv:Xr,createFileSystem:nr,createNodejsEnv:Jr,monkeyPatch:$n,isBrowser:qr,isNodejs:Se};function Ut(e){return w.isNodejs()||"string"!=typeof e?e:document.getElementById(e)}function O(e){let{Canvas:t,CanvasRenderingContext2D:r}=w.getEnv();if(e instanceof r)return e;let n=Ut(e);if(!(n instanceof t))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");let a=n.getContext("2d");if(!a)throw new Error("resolveContext2d - canvas 2d context is null");return a}Kr();var Qr=(e=>(e.TOP_LEFT="TOP_LEFT",e.TOP_RIGHT="TOP_RIGHT",e.BOTTOM_LEFT="BOTTOM_LEFT",e.BOTTOM_RIGHT="BOTTOM_RIGHT",e))(Qr||{}),fe=class{constructor(e={}){let{anchorPosition:t,backgroundColor:r,fontColor:n,fontSize:a,fontStyle:i,padding:o}=e;this.anchorPosition=t||"TOP_LEFT",this.backgroundColor=r||"rgba(0, 0, 0, 0.5)",this.fontColor=n||"rgba(255, 255, 255, 1)",this.fontSize=a||14,this.fontStyle=i||"Georgia",this.padding=o||4}},gt=class{constructor(e,t,r={}){this.text="string"==typeof e?[e]:e instanceof gt?e.text:e,this.anchor=t,this.options=new fe(r)}measureWidth(e){let{padding:t}=this.options;return this.text.map((t=>e.measureText(t).width)).reduce(((e,t)=>e<t?t:e),0)+2*t}measureHeight(){let{fontSize:e,padding:t}=this.options;return this.text.length*e+2*t}getUpperLeft(e,t){let{anchorPosition:r}=this.options,n="BOTTOM_RIGHT"===r||"TOP_RIGHT"===r,a="BOTTOM_LEFT"===r||"BOTTOM_RIGHT"===r,i=this.measureWidth(e),o=this.measureHeight(),s=n?this.anchor.x-i:this.anchor.x,c=a?this.anchor.y-o:this.anchor.y;if(t){let{width:e,height:r}=t;return{x:Math.max(Math.min(s,e-i),0),y:Math.max(Math.min(c,r-o),0)}}return{x:s,y:c}}draw(e){let t=Ut(e),r=O(t),{backgroundColor:n,fontColor:a,fontSize:i,fontStyle:o,padding:s}=this.options;r.font=`${i}px ${o}`;let c=this.measureWidth(r),h=this.measureHeight();r.fillStyle=n;let l=this.getUpperLeft(r,t);r.fillRect(l.x,l.y,c,h),r.fillStyle=a,this.text.forEach(((e,t)=>{let n=s+l.x,a=s+l.y+(t+1)*i;r.fillText(e,n,a)}))}},ar=class{constructor(e={}){let{boxColor:t,lineWidth:r,label:n,drawLabelOptions:a}=e;this.boxColor=t||"rgba(0, 0, 255, 1)",this.lineWidth=r||2,this.label=n;let i={anchorPosition:"BOTTOM_LEFT",backgroundColor:this.boxColor};this.drawLabelOptions=new fe({...i,...a})}},Le=class{constructor(e,t={}){this.box=new D(e),this.options=new ar(t)}draw(e){let t=O(e),{boxColor:r,lineWidth:n}=this.options,{x:a,y:i,width:o,height:s}=this.box;t.strokeStyle=r,t.lineWidth=n,t.strokeRect(a,i,o,s);let{label:c}=this.options;c&&new gt([c],{x:a-n/2,y:i},this.options.drawLabelOptions).draw(e)}};function On(e,t){(Array.isArray(t)?t:[t]).forEach((t=>{let r=t instanceof M?t.score:pt(t)?t.detection.score:void 0,n=t instanceof M?t.box:pt(t)?t.detection.box:new D(t),a=r?`${Ht(r)}`:void 0;new Le(n,{label:a}).draw(e)}))}var we=v(x());function Ae(e){let{Image:t,Video:r}=w.getEnv();return e instanceof t&&e.complete||e instanceof r&&e.readyState>=3}function to(e){return new Promise(((t,r)=>{function n(e){!e.currentTarget||(e.currentTarget.removeEventListener("load",a),e.currentTarget.removeEventListener("error",n),r(e))}function a(e){!e.currentTarget||(e.currentTarget.removeEventListener("load",a),e.currentTarget.removeEventListener("error",n),t(e))}(e instanceof w.getEnv().Canvas||Ae(e))&&t(null),e.addEventListener("load",a),e.addEventListener("error",n)}))}function eo(e){return new Promise(((t,r)=>{e instanceof Blob||r(new Error("bufferToImage - expected buf to be of type: Blob"));let n=new FileReader;n.onload=()=>{"string"!=typeof n.result&&r(new Error("bufferToImage - expected reader.result to be a string, in onload"));let e=w.getEnv().createImageElement();e.onload=()=>t(e),e.onerror=r,e.src=n.result},n.onerror=r,n.readAsDataURL(e)}))}function Xt(e){let{Image:t,Video:r}=w.getEnv();return e instanceof t?new k(e.naturalWidth,e.naturalHeight):e instanceof r?new k(e.videoWidth,e.videoHeight):new k(e.width,e.height)}function Jt({width:e,height:t}){let{createCanvasElement:r}=w.getEnv(),n=r();return n.width=e,n.height=t,n}function We(e,t){let{ImageData:r}=w.getEnv();if(!(e instanceof r||Ae(e)))throw new Error("createCanvasFromMedia - media has not finished loading yet");let{width:n,height:a}=t||Xt(e),i=Jt({width:n,height:a});return e instanceof r?O(i).putImageData(e,0,0):O(i).drawImage(e,0,0,n,a),i}var sr=v(x());async function ro(e,t){let r=t||w.getEnv().createCanvasElement(),[n,a,i]=e.shape.slice(U(e)?1:0),o=sr.tidy((()=>e.as3D(n,a,i).toInt()));return await sr.browser.toPixels(o,r),o.dispose(),r}function ir(e){let{Image:t,Canvas:r,Video:n}=w.getEnv();return e instanceof t||e instanceof r||e instanceof n}var V=v(x());function oo(e,t,r=!1){let{Image:n,Canvas:a}=w.getEnv();if(!(e instanceof n||e instanceof a))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");if(t<=0)return Jt({width:1,height:1});let i=Xt(e),o=t/Math.max(i.height,i.width),s=o*i.width,c=o*i.height,h=Jt({width:t,height:t}),l=e instanceof a?e:We(e),d=Math.abs(s-c)/2,u=r&&s<c?d:0,p=r&&c<s?d:0;return l.width>0&&l.height>0&&O(h).drawImage(l,u,p,s,c),h}var ut=class{constructor(e,t=!1){if(this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],this._inputSize=0,!Array.isArray(e))throw new Error(`NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have ${e}`);this._treatAsBatchInput=t,this._batchSize=e.length,e.forEach(((e,t)=>{if(ht(e))return this._imageTensors[t]=e,void(this._inputDimensions[t]=e.shape);if(U(e)){let r=e.shape[0];if(1!==r)throw new Error(`NetInput - tf.Tensor4D with batchSize ${r} passed, but not supported in input array`);return this._imageTensors[t]=e,void(this._inputDimensions[t]=e.shape.slice(1))}let r=e instanceof w.getEnv().Canvas?e:We(e);this._canvases[t]=r,this._inputDimensions[t]=[r.height,r.width,3]}))}get imageTensors(){return this._imageTensors}get canvases(){return this._canvases}get isBatchInput(){return this.batchSize>1||this._treatAsBatchInput}get batchSize(){return this._batchSize}get inputDimensions(){return this._inputDimensions}get inputSize(){return this._inputSize}get reshapedInputDimensions(){return it(this.batchSize,0,1).map(((e,t)=>this.getReshapedInputDimensions(t)))}getInput(e){return this.canvases[e]||this.imageTensors[e]}getInputDimensions(e){return this._inputDimensions[e]}getInputHeight(e){return this._inputDimensions[e][0]}getInputWidth(e){return this._inputDimensions[e][1]}getReshapedInputDimensions(e){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return Or({width:this.getInputWidth(e),height:this.getInputHeight(e)},this.inputSize)}toBatchTensor(e,t=!0){return this._inputSize=e,V.tidy((()=>{let r=it(this.batchSize,0,1).map((r=>{let n=this.getInput(r);if(n instanceof V.Tensor){let r=U(n)?n:V.expandDims(n);return r=Gr(r,t),(r.shape[1]!==e||r.shape[2]!==e)&&(r=V.image.resizeBilinear(r,[e,e],!1,!1)),r.as3D(e,e,3)}if(n instanceof w.getEnv().Canvas)return V.browser.fromPixels(oo(n,e,t));throw new Error(`toBatchTensor - at batchIdx ${r}, expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have ${n}`)}));return V.stack(r.map((e=>V.cast(e,"float32")))).as4D(this.batchSize,e,e,3)}))}};async function C(e){if(e instanceof ut)return e;let t=Array.isArray(e)?e:[e];if(!t.length)throw new Error("toNetInput - empty array passed as input");let r=t=>Array.isArray(e)?` at input index ${t}:`:"",n=t.map(Ut);return n.forEach(((e,n)=>{if(!ir(e)&&!ht(e)&&!U(e))throw"string"==typeof t[n]?new Error(`toNetInput -${r(n)} string passed, but could not resolve HTMLElement for element id ${t[n]}`):new Error(`toNetInput -${r(n)} expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id`);if(U(e)){let t=e.shape[0];if(1!==t)throw new Error(`toNetInput -${r(n)} tf.Tensor4D with batchSize ${t} passed, but not supported in input array`)}})),await Promise.all(n.map((e=>ir(e)&&to(e)))),new ut(n,Array.isArray(e))}async function le(e,t){let{Canvas:r}=w.getEnv(),n=e;if(!(e instanceof r)){let t=await C(e);if(t.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");let a=t.getInput(0);n=a instanceof r?a:await ro(a)}let a=O(n);return t.map((e=>e instanceof M?e.forSize(n.width,n.height).box.floor():e)).map((e=>e.clipAtImageBorders(n.width,n.height))).map((({x:e,y:t,width:r,height:n})=>{let i=Jt({width:r,height:n});return r>0&&n>0&&O(i).putImageData(a.getImageData(e,t,r,n),0,0),i}))}var cr=v(x());async function de(e,t){if(!ht(e)&&!U(e))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(U(e)&&e.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return cr.tidy((()=>{let[r,n,a]=e.shape.slice(U(e)?1:0);return t.map((e=>e instanceof M?e.forSize(n,r).box:e)).map((e=>e.clipAtImageBorders(n,r))).filter((e=>e.width>0&&e.height>0)).map((({x:t,y:i,width:o,height:s})=>cr.slice3d(e.as3D(r,n,a),[i,t,0],[s,o,a])))}))}async function xt(e,t){let{fetch:r}=w.getEnv(),n=await r(e,t);if(!(n.status<400))throw new Error(`failed to fetch: (${n.status}) ${n.statusText}, from url: ${n.url}`);return n}async function Hn(e){let t=await xt(e),r=await t.blob();if(!r.type.startsWith("image/"))throw new Error(`fetchImage - expected blob type to be of type image/*, instead have: ${r.type}, for url: ${t.url}`);return eo(r)}async function no(e){return(await xt(e)).json()}async function zn(e){return new Float32Array(await(await xt(e)).arrayBuffer())}function Fo(e){return new Promise(((t,r)=>{e instanceof Blob||r(new Error("bufferToVideo - expected buf to be of type: Blob"));let n=w.getEnv().createVideoElement();n.oncanplay=()=>t(n),n.onerror=r,n.playsInline=!0,n.muted=!0,n.src=URL.createObjectURL(e),n.play()}))}async function Vn(e){let t=await xt(e),r=await t.blob();if(!r.type.startsWith("video/"))throw new Error(`fetchVideo - expected blob type to be of type video/*, instead have: ${r.type}, for url: ${t.url}`);return Fo(r)}var Do=v(x());function mr(e,t){let r=`${t}-weights_manifest.json`;if(!e)return{modelBaseUri:"",manifestUri:r};if("/"===e)return{modelBaseUri:"/",manifestUri:`/${r}`};let n=e.startsWith("http://")?"http://":e.startsWith("https://")?"https://":"",a=(e=e.replace(n,"")).split("/").filter((e=>e)),i=e.endsWith(".json")?a[a.length-1]:r,o=n+(e.endsWith(".json")?a.slice(0,a.length-1):a).join("/");return o=e.startsWith("/")?`/${o}`:o,{modelBaseUri:o,manifestUri:"/"===o?`/${i}`:`${o}/${i}`}}async function ao(e,t){let{manifestUri:r,modelBaseUri:n}=mr(e,t),a=await no(r);return Do.io.loadWeights(a,n)}function Yn(e,t,r=!1){let{width:n,height:a}=r?Xt(t):t;return e.width=n,e.height=a,{width:n,height:a}}var ye=v(x()),vt=v(x()),A=class{constructor(e){this._params=void 0,this._paramMappings=[],this._name=e}get params(){return this._params}get paramMappings(){return this._paramMappings}get isLoaded(){return!!this.params}getParamFromPath(e){let{obj:t,objProp:r}=this.traversePropertyPath(e);return t[r]}reassignParamFromPath(e,t){let{obj:r,objProp:n}=this.traversePropertyPath(e);r[n].dispose(),r[n]=t}getParamList(){return this._paramMappings.map((({paramPath:e})=>({path:e,tensor:this.getParamFromPath(e)})))}getTrainableParams(){return this.getParamList().filter((e=>e.tensor instanceof vt.Variable))}getFrozenParams(){return this.getParamList().filter((e=>!(e.tensor instanceof vt.Variable)))}variable(){this.getFrozenParams().forEach((({path:e,tensor:t})=>{this.reassignParamFromPath(e,t.variable())}))}freeze(){this.getTrainableParams().forEach((({path:e,tensor:t})=>{let r=vt.tensor(t.dataSync());t.dispose(),this.reassignParamFromPath(e,r)}))}dispose(e=!0){this.getParamList().forEach((t=>{if(e&&t.tensor.isDisposed)throw new Error(`param tensor has already been disposed for path ${t.path}`);t.tensor.dispose()})),this._params=void 0}serializeParams(){return new Float32Array(this.getParamList().map((({tensor:e})=>Array.from(e.dataSync()))).reduce(((e,t)=>e.concat(t))))}async load(e){e instanceof Float32Array?this.extractWeights(e):await this.loadFromUri(e)}async loadFromUri(e){if(e&&"string"!=typeof e)throw new Error(`${this._name}.loadFromUri - expected model uri`);let t=await ao(e,this.getDefaultModelName());this.loadFromWeightMap(t)}async loadFromDisk(e){if(e&&"string"!=typeof e)throw new Error(`${this._name}.loadFromDisk - expected model file path`);let{readFile:t}=w.getEnv(),{manifestUri:r,modelBaseUri:n}=mr(e,this.getDefaultModelName()),a=vt.io.weightsLoaderFactory((e=>Promise.all(e.map((e=>t(e).then((e=>e.buffer))))))),i=JSON.parse((await t(r)).toString()),o=await a(i,n);this.loadFromWeightMap(o)}loadFromWeightMap(e){let{paramMappings:t,params:r}=this.extractParamsFromWeightMap(e);this._paramMappings=t,this._params=r}extractWeights(e){let{paramMappings:t,params:r}=this.extractParams(e);this._paramMappings=t,this._params=r}traversePropertyPath(e){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");let t=e.split("/").reduce(((t,r)=>{if(!t.nextObj.hasOwnProperty(r))throw new Error(`traversePropertyPath - object does not have property ${r}, for path ${e}`);return{obj:t.nextObj,objProp:r,nextObj:t.nextObj[r]}}),{nextObj:this.params}),{obj:r,objProp:n}=t;if(!(r&&n&&r[n]instanceof vt.Tensor))throw new Error(`traversePropertyPath - parameter is not a tensor, for path ${e}`);return{obj:r,objProp:n}}},I=v(x()),he=v(x());function H(e,t,r){return he.tidy((()=>{let n=he.separableConv2d(e,t.depthwise_filter,t.pointwise_filter,r,"same");return n=he.add(n,t.bias),n}))}function pr(e,t,r=!1){return I.tidy((()=>{let n=I.relu(r?I.add(I.conv2d(e,t.conv0.filters,[2,2],"same"),t.conv0.bias):H(e,t.conv0,[2,2])),a=H(n,t.conv1,[1,1]),i=H(I.relu(I.add(n,a)),t.conv2,[1,1]);return I.relu(I.add(n,I.add(a,i)))}))}function ke(e,t,r=!1,n=!0){return I.tidy((()=>{let a=I.relu(r?I.add(I.conv2d(e,t.conv0.filters,n?[2,2]:[1,1],"same"),t.conv0.bias):H(e,t.conv0,n?[2,2]:[1,1])),i=H(a,t.conv1,[1,1]),o=H(I.relu(I.add(a,i)),t.conv2,[1,1]),s=H(I.relu(I.add(a,I.add(i,o))),t.conv3,[1,1]);return I.relu(I.add(a,I.add(i,I.add(o,s))))}))}var It=v(x());function qt(e,t,r="same",n=!1){return It.tidy((()=>{let a=It.add(It.conv2d(e,t.filters,[1,1],r),t.bias);return n?It.relu(a):a}))}function B(e,t){Object.keys(e).forEach((r=>{t.some((e=>e.originalPath===r))||e[r].dispose()}))}var ur=v(x());function be(e,t){return(r,n,a,i)=>{let o=ur.tensor4d(e(r*n*a*a),[a,a,r,n]),s=ur.tensor1d(e(n));return t.push({paramPath:`${i}/filters`},{paramPath:`${i}/bias`}),{filters:o,bias:s}}}var fr=v(x());function lr(e,t){return(r,n,a)=>{let i=fr.tensor2d(e(r*n),[r,n]),o=fr.tensor1d(e(n));return t.push({paramPath:`${a}/weights`},{paramPath:`${a}/bias`}),{weights:i,bias:o}}}var Re=v(x()),Be=class{constructor(e,t,r){this.depthwise_filter=e,this.pointwise_filter=t,this.bias=r}};function ge(e,t){return(r,n,a)=>{let i=Re.tensor4d(e(9*r),[3,3,r,1]),o=Re.tensor4d(e(r*n),[1,1,r,n]),s=Re.tensor1d(e(n));return t.push({paramPath:`${a}/depthwise_filter`},{paramPath:`${a}/pointwise_filter`},{paramPath:`${a}/bias`}),new Be(i,o,s)}}function xe(e){return t=>{let r=e(`${t}/depthwise_filter`,4),n=e(`${t}/pointwise_filter`,4),a=e(`${t}/bias`,1);return new Be(r,n,a)}}function Y(e,t){return(r,n,a)=>{let i=e[r];if(!Ot(i,n))throw new Error(`expected weightMap[${r}] to be a Tensor${n}D, instead have ${i}`);return t.push({originalPath:r,paramPath:a||r}),i}}function R(e){let t=e;return{extractWeights:function(e){let r=t.slice(0,e);return t=t.slice(e),r},getRemainingWeights:function(){return t}}}function dr(e,t){let r=be(e,t),n=ge(e,t);function a(e,t,a,i=!1){return{conv0:i?r(e,t,3,`${a}/conv0`):n(e,t,`${a}/conv0`),conv1:n(t,t,`${a}/conv1`),conv2:n(t,t,`${a}/conv2`)}}return{extractDenseBlock3Params:a,extractDenseBlock4Params:function(e,t,r,i=!1){let{conv0:o,conv1:s,conv2:c}=a(e,t,r,i);return{conv0:o,conv1:s,conv2:c,conv3:n(t,t,`${r}/conv3`)}}}}function Eo(e){let t=[],{extractWeights:r,getRemainingWeights:n}=R(e),{extractDenseBlock4Params:a}=dr(r,t),i=a(3,32,"dense0",!0),o=a(32,64,"dense1"),s=a(64,128,"dense2"),c=a(128,256,"dense3");if(0!==n().length)throw new Error(`weights remaing after extract: ${n().length}`);return{paramMappings:t,params:{dense0:i,dense1:o,dense2:s,dense3:c}}}function hr(e){return t=>({filters:e(`${t}/filters`,4),bias:e(`${t}/bias`,1)})}function br(e,t){let r=Y(e,t),n=hr(r),a=xe(r);return{extractDenseBlock3Params:function(e,t=!1){return{conv0:t?n(`${e}/conv0`):a(`${e}/conv0`),conv1:a(`${e}/conv1`),conv2:a(`${e}/conv2`)}},extractDenseBlock4Params:function(e,t=!1){return{conv0:t?n(`${e}/conv0`):a(`${e}/conv0`),conv1:a(`${e}/conv1`),conv2:a(`${e}/conv2`),conv3:a(`${e}/conv3`)}}}}function Mo(e){let t=[],{extractDenseBlock4Params:r}=br(e,t),n={dense0:r("dense0",!0),dense1:r("dense1"),dense2:r("dense2"),dense3:r("dense3")};return B(e,t),{params:n,paramMappings:t}}var ve=class extends A{constructor(){super("FaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceFeatureExtractor - load model before inference");return ye.tidy((()=>{let r=ke(rt(ye.cast(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),t.dense0,!0);return r=ke(r,t.dense1),r=ke(r,t.dense2),r=ke(r,t.dense3),r=ye.avgPool(r,[7,7],[2,2],"valid"),r}))}async forward(e){return this.forwardInput(await C(e))}getDefaultModelName(){return"face_feature_extractor_model"}extractParamsFromWeightMap(e){return Mo(e)}extractParams(e){return Eo(e)}},No=v(x()),_e=v(x());function $e(e,t){return _e.tidy((()=>_e.add(_e.matMul(e,t.weights),t.bias)))}function Co(e,t,r){let n=[],{extractWeights:a,getRemainingWeights:i}=R(e),o=lr(a,n)(t,r,"fc");if(0!==i().length)throw new Error(`weights remaing after extract: ${i().length}`);return{paramMappings:n,params:{fc:o}}}function Io(e){let t=[],r=Y(e,t),n={fc:("fc",{weights:r("fc/weights",2),bias:r("fc/bias",1)})};return B(e,t),{params:n,paramMappings:t}}function gr(e){let t={},r={};return Object.keys(e).forEach((n=>{(n.startsWith("fc")?r:t)[n]=e[n]})),{featureExtractorMap:t,classifierMap:r}}var Te=class extends A{constructor(e,t){super(e),this._faceFeatureExtractor=t}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return No.tidy((()=>{let r=e instanceof ut?this.faceFeatureExtractor.forwardInput(e):e;return $e(r.as2D(r.shape[0],-1),t.fc)}))}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:r}=this.extractClassifierParams(e);this._params=t,this._paramMappings=r}extractClassifierParams(e){return Co(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:r}=gr(e);return this.faceFeatureExtractor.loadFromWeightMap(t),Io(r)}extractParams(e){let t=this.getClassifierChannelsIn(),r=this.getClassifierChannelsOut(),n=r*t+r,a=e.slice(0,e.length-n),i=e.slice(e.length-n);return this.faceFeatureExtractor.extractWeights(a),this.extractClassifierParams(i)}},so=["neutral","happy","sad","angry","fearful","disgusted","surprised"],yt=class{constructor(e){if(this.neutral=0,this.happy=0,this.sad=0,this.angry=0,this.fearful=0,this.disgusted=0,this.surprised=0,7!==e.length)throw new Error(`FaceExpressions.constructor - expected probabilities.length to be 7, have: ${e.length}`);so.forEach(((t,r)=>{this[t]=e[r]}))}asSortedArray(){return so.map((e=>({expression:e,probability:this[e]}))).sort(((e,t)=>t.probability-e.probability))}},Oe=class extends Te{constructor(e=new ve){super("FaceExpressionNet",e)}forwardInput(e){return we.tidy((()=>we.softmax(this.runNet(e))))}async forward(e){return this.forwardInput(await C(e))}async predictExpressions(e){let t=await C(e),r=await this.forwardInput(t),n=await Promise.all(we.unstack(r).map((async e=>{let t=e.dataSync();return e.dispose(),t})));r.dispose();let a=n.map((e=>new yt(e)));return t.isBatchInput?a:a[0]}getDefaultModelName(){return"face_expression_model"}getClassifierChannelsIn(){return 256}getClassifierChannelsOut(){return 7}};function io(e){return e.expressions instanceof yt}function xr(e,t){return{...e,expressions:t}}function Gn(e,t,r=.1,n){(Array.isArray(t)?t:[t]).forEach((t=>{let a=t instanceof yt?t:io(t)?t.expressions:void 0;if(!a)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");let i=a.asSortedArray().filter((e=>e.probability>r)),o=pt(t)?t.detection.box.bottomLeft:n||new g(0,0);new gt(i.map((e=>`${e.expression} (${Ht(e.probability)})`)),o).draw(e)}))}function Zt(e){return pt(e)&&e.landmarks instanceof z&&e.unshiftedLandmarks instanceof z&&e.alignedRect instanceof M}function jn(e){let t=e=>180*e/Math.PI,r=(e,t)=>Math.sqrt((e._x-t._x)**2+(e._y-t._y)**2),n={roll:void 0,pitch:void 0,yaw:void 0};if(!e||!e._positions||68!==e._positions.length)return n;let a=e._positions;return n.roll=((e,r)=>{let n=Math.hypot(r._x-e._x,r._y-e._y),a=r._y-e._y,i=Math.asin(a/n),o=t(i);return Math.floor(90-o)*(r._x-e._x<0?-1:1)})(a[27],a[66]),n.pitch=((e,n,a)=>{let i=r(e,a),o={_x:(e._x+a._x)/2,_y:(e._y+a._y)/2},s=r(n,o),c=Math.atan(s/i);return Math.floor(t(c))*(o._y-n._y<0?-1:1)})(a[14],a[30],a[2]),n.yaw=(i=a[14],o=a[33],s=a[2],Math.floor(i._x-o._x)-Math.floor(o._x-s._x)),n;var i,o,s}function Pe(e,t){let{box:r}=e.detection,n=t.shiftBy(r.x,r.y),a=n.align(),{imageDims:i}=e.detection,o=new M(e.detection.score,a.rescale(i.reverse()),i),s=jn(t);return{...e,landmarks:n,unshiftedLandmarks:t,alignedRect:o,angle:s}}var vr=class{constructor(e={}){let{drawLines:t=!0,drawPoints:r=!0,lineWidth:n,lineColor:a,pointSize:i,pointColor:o}=e;this.drawLines=t,this.drawPoints=r,this.lineWidth=n||1,this.pointSize=i||2,this.lineColor=a||"rgba(0, 255, 255, 1)",this.pointColor=o||"rgba(255, 0, 255, 1)"}},yr=class{constructor(e,t={}){this.faceLandmarks=e,this.options=new vr(t)}draw(e){let t=O(e),{drawLines:r,drawPoints:n,lineWidth:a,lineColor:i,pointSize:o,pointColor:s}=this.options;if(r&&this.faceLandmarks instanceof Gt&&(t.strokeStyle=i,t.lineWidth=a,dt(t,this.faceLandmarks.getJawOutline()),dt(t,this.faceLandmarks.getLeftEyeBrow()),dt(t,this.faceLandmarks.getRightEyeBrow()),dt(t,this.faceLandmarks.getNose()),dt(t,this.faceLandmarks.getLeftEye(),!0),dt(t,this.faceLandmarks.getRightEye(),!0),dt(t,this.faceLandmarks.getMouth(),!0)),n){t.strokeStyle=s,t.fillStyle=s;let e=e=>{t.beginPath(),t.arc(e.x,e.y,o,0,2*Math.PI),t.fill()};this.faceLandmarks.positions.forEach(e)}}};function Un(e,t){(Array.isArray(t)?t:[t]).forEach((t=>{let r=t instanceof z?t:Zt(t)?t.landmarks:void 0;if(!r)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new yr(r).draw(e)}))}var So="1.7.7",ft=v(x()),S=v(x());function qn(e,t){let r=be(e,t),n=ge(e,t);return{extractConvParams:r,extractSeparableConvParams:n,extractReductionBlockParams:function(e,t,a){return{separable_conv0:n(e,t,`${a}/separable_conv0`),separable_conv1:n(t,t,`${a}/separable_conv1`),expansion_conv:r(e,t,1,`${a}/expansion_conv`)}},extractMainBlockParams:function(e,t){return{separable_conv0:n(e,e,`${t}/separable_conv0`),separable_conv1:n(e,e,`${t}/separable_conv1`),separable_conv2:n(e,e,`${t}/separable_conv2`)}}}}function Lo(e,t){let r=[],{extractWeights:n,getRemainingWeights:a}=R(e),{extractConvParams:i,extractSeparableConvParams:o,extractReductionBlockParams:s,extractMainBlockParams:c}=qn(n,r),h={conv_in:i(3,32,3,"entry_flow/conv_in"),reduction_block_0:s(32,64,"entry_flow/reduction_block_0"),reduction_block_1:s(64,128,"entry_flow/reduction_block_1")},l={};it(t,0,1).forEach((e=>{l[`main_block_${e}`]=c(128,`middle_flow/main_block_${e}`)}));let d={reduction_block:s(128,256,"exit_flow/reduction_block"),separable_conv:o(256,512,"exit_flow/separable_conv")};if(0!==a().length)throw new Error(`weights remaing after extract: ${a().length}`);return{paramMappings:r,params:{entry_flow:h,middle_flow:l,exit_flow:d}}}function Zn(e,t){let r=Y(e,t),n=hr(r),a=xe(r);return{extractConvParams:n,extractSeparableConvParams:a,extractReductionBlockParams:function(e){return{separable_conv0:a(`${e}/separable_conv0`),separable_conv1:a(`${e}/separable_conv1`),expansion_conv:n(`${e}/expansion_conv`)}},extractMainBlockParams:function(e){return{separable_conv0:a(`${e}/separable_conv0`),separable_conv1:a(`${e}/separable_conv1`),separable_conv2:a(`${e}/separable_conv2`)}}}}function Ao(e,t){let r=[],{extractConvParams:n,extractSeparableConvParams:a,extractReductionBlockParams:i,extractMainBlockParams:o}=Zn(e,r),s={conv_in:n("entry_flow/conv_in"),reduction_block_0:i("entry_flow/reduction_block_0"),reduction_block_1:i("entry_flow/reduction_block_1")},c={};it(t,0,1).forEach((e=>{c[`main_block_${e}`]=o(`middle_flow/main_block_${e}`)}));let h={reduction_block:i("exit_flow/reduction_block"),separable_conv:a("exit_flow/separable_conv")};return B(e,r),{params:{entry_flow:s,middle_flow:c,exit_flow:h},paramMappings:r}}function Wo(e,t,r){return S.add(S.conv2d(e,t.filters,r,"same"),t.bias)}function mo(e,t,r=!0){let n=r?S.relu(e):e;return n=H(n,t.separable_conv0,[1,1]),n=H(S.relu(n),t.separable_conv1,[1,1]),n=S.maxPool(n,[3,3],[2,2],"same"),n=S.add(n,Wo(e,t.expansion_conv,[2,2])),n}function Kn(e,t){let r=H(S.relu(e),t.separable_conv0,[1,1]);return r=H(S.relu(r),t.separable_conv1,[1,1]),r=H(S.relu(r),t.separable_conv2,[1,1]),r=S.add(r,e),r}var _r=class extends A{constructor(e){super("TinyXception"),this._numMainBlocks=e}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyXception - load model before inference");return S.tidy((()=>{let r=rt(S.cast(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),n=S.relu(Wo(r,t.entry_flow.conv_in,[2,2]));return n=mo(n,t.entry_flow.reduction_block_0,!1),n=mo(n,t.entry_flow.reduction_block_1),it(this._numMainBlocks,0,1).forEach((e=>{n=Kn(n,t.middle_flow[`main_block_${e}`])})),n=mo(n,t.exit_flow.reduction_block),n=S.relu(H(n,t.exit_flow.separable_conv,[1,1])),n}))}async forward(e){return this.forwardInput(await C(e))}getDefaultModelName(){return"tiny_xception_model"}extractParamsFromWeightMap(e){return Ao(e,this._numMainBlocks)}extractParams(e){return Lo(e,this._numMainBlocks)}};function ko(e){let t=[],{extractWeights:r,getRemainingWeights:n}=R(e),a=lr(r,t),i=a(512,1,"fc/age"),o=a(512,2,"fc/gender");if(0!==n().length)throw new Error(`weights remaing after extract: ${n().length}`);return{paramMappings:t,params:{fc:{age:i,gender:o}}}}function Bo(e){let t=[],r=Y(e,t);function n(e){return{weights:r(`${e}/weights`,2),bias:r(`${e}/bias`,1)}}let a={fc:{age:n("fc/age"),gender:n("fc/gender")}};return B(e,t),{params:a,paramMappings:t}}var Tr=(e=>(e.FEMALE="female",e.MALE="male",e))(Tr||{}),He=class extends A{constructor(e=new _r(2)){super("AgeGenderNet"),this._faceFeatureExtractor=e}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return ft.tidy((()=>{let r=e instanceof ut?this.faceFeatureExtractor.forwardInput(e):e,n=ft.avgPool(r,[7,7],[2,2],"valid").as2D(r.shape[0],-1);return{age:$e(n,t.fc.age).as1D(),gender:$e(n,t.fc.gender)}}))}forwardInput(e){return ft.tidy((()=>{let{age:t,gender:r}=this.runNet(e);return{age:t,gender:ft.softmax(r)}}))}async forward(e){return this.forwardInput(await C(e))}async predictAgeAndGender(e){let t=await C(e),r=await this.forwardInput(t),n=ft.unstack(r.age),a=ft.unstack(r.gender),i=n.map(((e,t)=>({ageTensor:e,genderTensor:a[t]}))),o=await Promise.all(i.map((async({ageTensor:e,genderTensor:t})=>{let r=e.dataSync()[0],n=t.dataSync()[0],a=n>.5,i=a?"male":"female",o=a?n:1-n;return e.dispose(),t.dispose(),{age:r,gender:i,genderProbability:o}})));return r.age.dispose(),r.gender.dispose(),t.isBatchInput?o:o[0]}getDefaultModelName(){return"age_gender_model"}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:r}=this.extractClassifierParams(e);this._params=t,this._paramMappings=r}extractClassifierParams(e){return ko(e)}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:r}=gr(e);return this.faceFeatureExtractor.loadFromWeightMap(t),Bo(r)}extractParams(e){let t=e.slice(0,e.length-1539),r=e.slice(e.length-1539);return this.faceFeatureExtractor.extractWeights(t),this.extractClassifierParams(r)}},G=v(x()),Fe=class extends Te{postProcess(e,t,r){let n=r.map((({width:e,height:r})=>{let n=t/Math.max(r,e);return{width:e*n,height:r*n}})),a=n.length;return G.tidy((()=>{let r=(e,t)=>G.stack([G.fill([68],e,"float32"),G.fill([68],t,"float32")],1).as2D(1,136).as1D(),i=(e,t)=>{let{width:r,height:a}=n[e];return t(r,a)?Math.abs(r-a)/2:0};return e.mul(G.fill([a,136],t,"float32")).sub(G.stack(Array.from(Array(a),((e,t)=>r((e=>i(e,((e,t)=>e<t)))(t),(e=>i(e,((e,t)=>t<e)))(t)))))).div(G.stack(Array.from(Array(a),((e,t)=>r(n[t].width,n[t].height)))))}))}forwardInput(e){return G.tidy((()=>{let t=this.runNet(e);return this.postProcess(t,e.inputSize,e.inputDimensions.map((([e,t])=>({height:e,width:t}))))}))}async forward(e){return this.forwardInput(await C(e))}async detectLandmarks(e){let t=await C(e),r=G.tidy((()=>G.unstack(this.forwardInput(t)))),n=await Promise.all(r.map((async(e,r)=>{let n=Array.from(e.dataSync()),a=n.filter(((e,t)=>rr(t))),i=n.filter(((e,t)=>!rr(t)));return new Gt(Array(68).fill(0).map(((e,t)=>new g(a[t],i[t]))),{height:t.getInputHeight(r),width:t.getInputWidth(r)})})));return r.forEach((e=>e.dispose())),t.isBatchInput?n:n[0]}getClassifierChannelsOut(){return 136}},Kt=class extends Fe{constructor(e=new ve){super("FaceLandmark68Net",e)}getDefaultModelName(){return"face_landmark_68_model"}getClassifierChannelsIn(){return 256}},De=v(x());function Ro(e){let t=[],{extractDenseBlock3Params:r}=br(e,t),n={dense0:r("dense0",!0),dense1:r("dense1"),dense2:r("dense2")};return B(e,t),{params:n,paramMappings:t}}function $o(e){let t=[],{extractWeights:r,getRemainingWeights:n}=R(e),{extractDenseBlock3Params:a}=dr(r,t),i=a(3,32,"dense0",!0),o=a(32,64,"dense1"),s=a(64,128,"dense2");if(0!==n().length)throw new Error(`weights remaing after extract: ${n().length}`);return{paramMappings:t,params:{dense0:i,dense1:o,dense2:s}}}var wr=class extends A{constructor(){super("TinyFaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyFaceFeatureExtractor - load model before inference");return De.tidy((()=>{let r=pr(rt(De.cast(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),t.dense0,!0);return r=pr(r,t.dense1),r=pr(r,t.dense2),r=De.avgPool(r,[14,14],[2,2],"valid"),r}))}async forward(e){return this.forwardInput(await C(e))}getDefaultModelName(){return"face_feature_extractor_tiny_model"}extractParamsFromWeightMap(e){return Ro(e)}extractParams(e){return $o(e)}},ze=class extends Fe{constructor(e=new wr){super("FaceLandmark68TinyNet",e)}getDefaultModelName(){return"face_landmark_68_tiny_model"}getClassifierChannelsIn(){return 128}},po=class extends Kt{},nt=v(x()),Ee=v(x()),Pr=v(x());function Oo(e,t){return Pr.add(Pr.mul(e,t.weights),t.biases)}function uo(e,t,r,n,a="same"){let{filters:i,bias:o}=t.conv,s=Ee.conv2d(e,i,r,a);return s=Ee.add(s,o),s=Oo(s,t.scale),n?Ee.relu(s):s}function Ho(e,t){return uo(e,t,[1,1],!0)}function fo(e,t){return uo(e,t,[1,1],!1)}function Fr(e,t){return uo(e,t,[2,2],!0,"valid")}var j=v(x());function Qn(e,t){function r(r,n,a,i){let o=function(r,n,a,i){let o=function(t,r,n){let a=e(t),i=a.length/(r*n*n);if($r(i))throw new Error(`depth has to be an integer: ${i}, weights.length: ${a.length}, numFilters: ${r}, filterSize: ${n}`);return j.tidy((()=>j.transpose(j.tensor4d(a,[r,i,n,n]),[2,3,1,0])))}(r,n,a),s=j.tensor1d(e(n));return t.push({paramPath:`${i}/filters`},{paramPath:`${i}/bias`}),{filters:o,bias:s}}(r,n,a,`${i}/conv`),s=function(r,n){let a=j.tensor1d(e(r)),i=j.tensor1d(e(r));return t.push({paramPath:`${n}/weights`},{paramPath:`${n}/biases`}),{weights:a,biases:i}}(n,`${i}/scale`);return{conv:o,scale:s}}return{extractConvLayerParams:r,extractResidualLayerParams:function(e,t,n,a,i=!1){return{conv1:r((i?.5:1)*e,t,n,`${a}/conv1`),conv2:r(e,t,n,`${a}/conv2`)}}}}function zo(e){let{extractWeights:t,getRemainingWeights:r}=R(e),n=[],{extractConvLayerParams:a,extractResidualLayerParams:i}=Qn(t,n),o=a(4704,32,7,"conv32_down"),s=i(9216,32,3,"conv32_1"),c=i(9216,32,3,"conv32_2"),h=i(9216,32,3,"conv32_3"),l=i(36864,64,3,"conv64_down",!0),d=i(36864,64,3,"conv64_1"),u=i(36864,64,3,"conv64_2"),p=i(36864,64,3,"conv64_3"),f=i(147456,128,3,"conv128_down",!0),m=i(147456,128,3,"conv128_1"),g=i(147456,128,3,"conv128_2"),v=i(589824,256,3,"conv256_down",!0),w=i(589824,256,3,"conv256_1"),_=i(589824,256,3,"conv256_2"),x=i(589824,256,3,"conv256_down_out"),b=j.tidy((()=>j.transpose(j.tensor2d(t(32768),[128,256]),[1,0])));if(n.push({paramPath:"fc"}),0!==r().length)throw new Error(`weights remaing after extract: ${r().length}`);return{params:{conv32_down:o,conv32_1:s,conv32_2:c,conv32_3:h,conv64_down:l,conv64_1:d,conv64_2:u,conv64_3:p,conv128_down:f,conv128_1:m,conv128_2:g,conv256_down:v,conv256_1:w,conv256_2:_,conv256_down_out:x,fc:b},paramMappings:n}}function ta(e,t){let r=Y(e,t);function n(e){let t=r(`${e}/conv/filters`,4),n=r(`${e}/conv/bias`,1),a=function(e){return{weights:r(`${e}/scale/weights`,1),biases:r(`${e}/scale/biases`,1)}}(e);return{conv:{filters:t,bias:n},scale:a}}return{extractConvLayerParams:n,extractResidualLayerParams:function(e){return{conv1:n(`${e}/conv1`),conv2:n(`${e}/conv2`)}}}}function Vo(e){let t=[],{extractConvLayerParams:r,extractResidualLayerParams:n}=ta(e,t),a=r("conv32_down"),i=n("conv32_1"),o=n("conv32_2"),s=n("conv32_3"),c=n("conv64_down"),h=n("conv64_1"),l=n("conv64_2"),d=n("conv64_3"),u=n("conv128_down"),p=n("conv128_1"),f=n("conv128_2"),m=n("conv256_down"),g=n("conv256_1"),v=n("conv256_2"),w=n("conv256_down_out"),{fc:_}=e;if(t.push({originalPath:"fc",paramPath:"fc"}),!Rr(_))throw new Error(`expected weightMap[fc] to be a Tensor2D, instead have ${_}`);let x={conv32_down:a,conv32_1:i,conv32_2:o,conv32_3:s,conv64_down:c,conv64_1:h,conv64_2:l,conv64_3:d,conv128_down:u,conv128_1:p,conv128_2:f,conv256_down:m,conv256_1:g,conv256_2:v,conv256_down_out:w,fc:_};return B(e,t),{params:x,paramMappings:t}}var $=v(x());function ot(e,t){let r=Ho(e,t.conv1);return r=fo(r,t.conv2),r=$.add(r,e),r=$.relu(r),r}function Ve(e,t){let r=Fr(e,t.conv1);r=fo(r,t.conv2);let n=$.avgPool(e,2,2,"valid"),a=$.zeros(n.shape),i=n.shape[3]!==r.shape[3];if(n.shape[1]!==r.shape[1]||n.shape[2]!==r.shape[2]){let e=[...r.shape];e[1]=1;let t=$.zeros(e);r=$.concat([r,t],1);let n=[...r.shape];n[2]=1;let a=$.zeros(n);r=$.concat([r,a],2)}return n=i?$.concat([n,a],3):n,r=$.add(n,r),r=$.relu(r),r}var Qt=class extends A{constructor(){super("FaceRecognitionNet")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceRecognitionNet - load model before inference");return nt.tidy((()=>{let r=Fr(rt(nt.cast(e.toBatchTensor(150,!0),"float32"),[122.782,117.001,104.298]).div(255),t.conv32_down);r=nt.maxPool(r,3,2,"valid"),r=ot(r,t.conv32_1),r=ot(r,t.conv32_2),r=ot(r,t.conv32_3),r=Ve(r,t.conv64_down),r=ot(r,t.conv64_1),r=ot(r,t.conv64_2),r=ot(r,t.conv64_3),r=Ve(r,t.conv128_down),r=ot(r,t.conv128_1),r=ot(r,t.conv128_2),r=Ve(r,t.conv256_down),r=ot(r,t.conv256_1),r=ot(r,t.conv256_2),r=Ve(r,t.conv256_down_out);let n=r.mean([1,2]);return nt.matMul(n,t.fc)}))}async forward(e){return this.forwardInput(await C(e))}async computeFaceDescriptor(e){var t;if(null!=(t=null==e?void 0:e.shape)&&t.some((e=>e<=0)))return new Float32Array(128);let r=await C(e),n=nt.tidy((()=>nt.unstack(this.forwardInput(r)))),a=await Promise.all(n.map((e=>e.data())));return n.forEach((e=>e.dispose())),r.isBatchInput?a:a[0]}getDefaultModelName(){return"face_recognition_model"}extractParamsFromWeightMap(e){return Vo(e)}extractParams(e){return zo(e)}};function ea(e){let t=new Qt;return t.extractWeights(e),t}function Dr(e,t){return{...e,descriptor:t}}function ra(e){return"number"==typeof e.age}function Er(e,t){return{...e,age:t}}function oa(e){return("male"===e.gender||"female"===e.gender)&&me(e.genderProbability)}function Mr(e,t,r){return{...e,gender:t,genderProbability:r}}var Lt=v(x()),at=v(x());function na(e,t){function r(r,n,a,i,o){let s=at.tensor4d(e(r*n*a*a),[a,a,r,n]),c=at.tensor1d(e(n));return t.push({paramPath:`${i}/filters`},{paramPath:`${i}/${o?"batch_norm_offset":"bias"}`}),{filters:s,bias:c}}function n(e,t,n,a){let{filters:i,bias:o}=r(e,t,n,a,!0);return{filters:i,batch_norm_offset:o}}function a(r,a,i){let o=function(r,n){let a=at.tensor4d(e(9*r),[3,3,r,1]),i=at.tensor1d(e(r)),o=at.tensor1d(e(r)),s=at.tensor1d(e(r)),c=at.tensor1d(e(r));return t.push({paramPath:`${n}/filters`},{paramPath:`${n}/batch_norm_scale`},{paramPath:`${n}/batch_norm_offset`},{paramPath:`${n}/batch_norm_mean`},{paramPath:`${n}/batch_norm_variance`}),{filters:a,batch_norm_scale:i,batch_norm_offset:o,batch_norm_mean:s,batch_norm_variance:c}}(r,`${i}/depthwise_conv`);return{depthwise_conv:o,pointwise_conv:n(r,a,1,`${i}/pointwise_conv`)}}return{extractMobilenetV1Params:function(){return{conv_0:n(3,32,3,"mobilenetv1/conv_0"),conv_1:a(32,64,"mobilenetv1/conv_1"),conv_2:a(64,128,"mobilenetv1/conv_2"),conv_3:a(128,128,"mobilenetv1/conv_3"),conv_4:a(128,256,"mobilenetv1/conv_4"),conv_5:a(256,256,"mobilenetv1/conv_5"),conv_6:a(256,512,"mobilenetv1/conv_6"),conv_7:a(512,512,"mobilenetv1/conv_7"),conv_8:a(512,512,"mobilenetv1/conv_8"),conv_9:a(512,512,"mobilenetv1/conv_9"),conv_10:a(512,512,"mobilenetv1/conv_10"),conv_11:a(512,512,"mobilenetv1/conv_11"),conv_12:a(512,1024,"mobilenetv1/conv_12"),conv_13:a(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:n(1024,256,1,"prediction_layer/conv_0"),conv_1:n(256,512,3,"prediction_layer/conv_1"),conv_2:n(512,128,1,"prediction_layer/conv_2"),conv_3:n(128,256,3,"prediction_layer/conv_3"),conv_4:n(256,128,1,"prediction_layer/conv_4"),conv_5:n(128,256,3,"prediction_layer/conv_5"),conv_6:n(256,64,1,"prediction_layer/conv_6"),conv_7:n(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:r(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:r(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:r(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:r(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:r(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:r(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:r(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:r(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:r(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:r(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:r(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:r(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}function Yo(e){let t=[],{extractWeights:r,getRemainingWeights:n}=R(e),{extractMobilenetV1Params:a,extractPredictionLayerParams:i}=na(r,t),o=a(),s=i(),c={extra_dim:at.tensor3d(r(20472),[1,5118,4])};if(t.push({paramPath:"output_layer/extra_dim"}),0!==n().length)throw new Error(`weights remaing after extract: ${n().length}`);return{params:{mobilenetv1:o,prediction_layer:s,output_layer:c},paramMappings:t}}function aa(e,t){let r=Y(e,t);function n(e,t,n){return{filters:r(`${e}/Conv2d_${t}_pointwise/weights`,4,`${n}/filters`),batch_norm_offset:r(`${e}/Conv2d_${t}_pointwise/convolution_bn_offset`,1,`${n}/batch_norm_offset`)}}function a(e){let t=`mobilenetv1/conv_${e}`,a=`MobilenetV1/Conv2d_${e}_depthwise`,i=`${t}/depthwise_conv`,o=`${t}/pointwise_conv`;return{depthwise_conv:{filters:r(`${a}/depthwise_weights`,4,`${i}/filters`),batch_norm_scale:r(`${a}/BatchNorm/gamma`,1,`${i}/batch_norm_scale`),batch_norm_offset:r(`${a}/BatchNorm/beta`,1,`${i}/batch_norm_offset`),batch_norm_mean:r(`${a}/BatchNorm/moving_mean`,1,`${i}/batch_norm_mean`),batch_norm_variance:r(`${a}/BatchNorm/moving_variance`,1,`${i}/batch_norm_variance`)},pointwise_conv:n("MobilenetV1",e,o)}}function i(e,t){return{filters:r(`${e}/weights`,4,`${t}/filters`),bias:r(`${e}/biases`,1,`${t}/bias`)}}function o(e){return{box_encoding_predictor:i(`Prediction/BoxPredictor_${e}/BoxEncodingPredictor`,`prediction_layer/box_predictor_${e}/box_encoding_predictor`),class_predictor:i(`Prediction/BoxPredictor_${e}/ClassPredictor`,`prediction_layer/box_predictor_${e}/class_predictor`)}}return{extractMobilenetV1Params:function(){return{conv_0:n("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:a(1),conv_2:a(2),conv_3:a(3),conv_4:a(4),conv_5:a(5),conv_6:a(6),conv_7:a(7),conv_8:a(8),conv_9:a(9),conv_10:a(10),conv_11:a(11),conv_12:a(12),conv_13:a(13)}},extractPredictionLayerParams:function(){return{conv_0:n("Prediction",0,"prediction_layer/conv_0"),conv_1:n("Prediction",1,"prediction_layer/conv_1"),conv_2:n("Prediction",2,"prediction_layer/conv_2"),conv_3:n("Prediction",3,"prediction_layer/conv_3"),conv_4:n("Prediction",4,"prediction_layer/conv_4"),conv_5:n("Prediction",5,"prediction_layer/conv_5"),conv_6:n("Prediction",6,"prediction_layer/conv_6"),conv_7:n("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:o(0),box_predictor_1:o(1),box_predictor_2:o(2),box_predictor_3:o(3),box_predictor_4:o(4),box_predictor_5:o(5)}}}}function Go(e){let t=[],{extractMobilenetV1Params:r,extractPredictionLayerParams:n}=aa(e,t),a=e["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!ht(a))throw new Error(`expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have ${a}`);let i={mobilenetv1:r(),prediction_layer:n(),output_layer:{extra_dim:a}};return B(e,t),{params:i,paramMappings:t}}var _t=v(x()),Nt=v(x());function Z(e,t,r){return Nt.tidy((()=>{let n=Nt.conv2d(e,t.filters,r,"same");return n=Nt.add(n,t.batch_norm_offset),Nt.clipByValue(n,0,6)}))}var sa=.0010000000474974513;function ia(e,t,r){return _t.tidy((()=>{let n=_t.depthwiseConv2d(e,t.filters,r,"same");return n=_t.batchNorm(n,t.batch_norm_mean,t.batch_norm_variance,t.batch_norm_offset,t.batch_norm_scale,sa),_t.clipByValue(n,0,6)}))}function ca(e){return[2,4,6,12].some((t=>t===e))?[2,2]:[1,1]}function jo(e,t){return _t.tidy((()=>{let r,n=Z(e,t.conv_0,[2,2]);if([t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13].forEach(((e,t)=>{let a=t+1,i=ca(a);n=ia(n,e.depthwise_conv,i),n=Z(n,e.pointwise_conv,[1,1]),11===a&&(r=n)})),null===r)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:n,conv11:r}}))}function ma(e,t,r){let n=e.arraySync(),a=Math.min(n[t][0],n[t][2]),i=Math.min(n[t][1],n[t][3]),o=Math.max(n[t][0],n[t][2]),s=Math.max(n[t][1],n[t][3]),c=Math.min(n[r][0],n[r][2]),h=Math.min(n[r][1],n[r][3]),l=Math.max(n[r][0],n[r][2]),d=Math.max(n[r][1],n[r][3]),u=(o-a)*(s-i),p=(l-c)*(d-h);if(u<=0||p<=0)return 0;let f=Math.max(a,c),m=Math.max(i,h),g=Math.min(o,l),v=Math.min(s,d),w=Math.max(g-f,0)*Math.max(v-m,0);return w/(u+p-w)}function Uo(e,t,r,n,a){let i=e.shape[0],o=Math.min(r,i),s=t.map(((e,t)=>({score:e,boxIndex:t}))).filter((e=>e.score>a)).sort(((e,t)=>t.score-e.score)),c=e=>e<=n?1:0,h=[];return s.forEach((t=>{if(h.length>=o)return;let r=t.score;for(let r=h.length-1;r>=0;--r){let n=ma(e,t.boxIndex,h[r]);if(0!==n&&(t.score*=c(n),t.score<=a))break}r===t.score&&h.push(t.boxIndex)})),h}var d=v(x());function pa(e){let t=d.unstack(d.transpose(e,[1,0])),r=[d.sub(t[2],t[0]),d.sub(t[3],t[1])];return{sizes:r,centers:[d.add(t[0],d.div(r[0],2)),d.add(t[1],d.div(r[1],2))]}}function ua(e,t){let{sizes:r,centers:n}=pa(e),a=d.unstack(d.transpose(t,[1,0])),i=d.div(d.mul(d.exp(d.div(a[2],5)),r[0]),2),o=d.add(d.mul(d.div(a[0],10),r[0]),n[0]),s=d.div(d.mul(d.exp(d.div(a[3],5)),r[1]),2),c=d.add(d.mul(d.div(a[1],10),r[1]),n[1]);return d.transpose(d.stack([d.sub(o,i),d.sub(c,s),d.add(o,i),d.add(c,s)]),[1,0])}function Xo(e,t,r){return d.tidy((()=>{let n=e.shape[0],a=ua(d.reshape(d.tile(r.extra_dim,[n,1,1]),[-1,4]),d.reshape(e,[-1,4]));a=d.reshape(a,[n,a.shape[0]/n,4]);let i=d.sigmoid(d.slice(t,[0,0,1],[-1,-1,-1])),o=d.slice(i,[0,0,0],[-1,-1,1]);return o=d.reshape(o,[n,o.shape[1]]),{boxes:d.unstack(a),scores:d.unstack(o)}}))}var Ge=v(x()),Ye=v(x());function te(e,t){return Ye.tidy((()=>{let r=e.shape[0];return{boxPredictionEncoding:Ye.reshape(qt(e,t.box_encoding_predictor),[r,-1,1,4]),classPrediction:Ye.reshape(qt(e,t.class_predictor),[r,-1,3])}}))}function Jo(e,t,r){return Ge.tidy((()=>{let n=Z(e,r.conv_0,[1,1]),a=Z(n,r.conv_1,[2,2]),i=Z(a,r.conv_2,[1,1]),o=Z(i,r.conv_3,[2,2]),s=Z(o,r.conv_4,[1,1]),c=Z(s,r.conv_5,[2,2]),h=Z(c,r.conv_6,[1,1]),l=Z(h,r.conv_7,[2,2]),d=te(t,r.box_predictor_0),u=te(e,r.box_predictor_1),p=te(a,r.box_predictor_2),f=te(o,r.box_predictor_3),m=te(c,r.box_predictor_4),g=te(l,r.box_predictor_5);return{boxPredictions:Ge.concat([d.boxPredictionEncoding,u.boxPredictionEncoding,p.boxPredictionEncoding,f.boxPredictionEncoding,m.boxPredictionEncoding,g.boxPredictionEncoding],1),classPredictions:Ge.concat([d.classPrediction,u.classPrediction,p.classPrediction,f.classPrediction,m.classPrediction,g.classPrediction],1)}}))}var X=class{constructor({minConfidence:e,maxResults:t}={}){if(this._name="SsdMobilenetv1Options",this._minConfidence=e||.5,this._maxResults=t||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw new Error(`${this._name} - expected minConfidence to be a number between 0 and 1`);if("number"!=typeof this._maxResults)throw new Error(`${this._name} - expected maxResults to be a number`)}get minConfidence(){return this._minConfidence}get maxResults(){return this._maxResults}},St=class extends A{constructor(){super("SsdMobilenetv1")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("SsdMobilenetv1 - load model before inference");return Lt.tidy((()=>{let r=Lt.cast(e.toBatchTensor(512,!1),"float32"),n=jo(Lt.sub(Lt.div(r,127.5),1),t.mobilenetv1),{boxPredictions:a,classPredictions:i}=Jo(n.out,n.conv11,t.prediction_layer);return Xo(a,i,t.output_layer)}))}async forward(e){return this.forwardInput(await C(e))}async locateFaces(e,t={}){let{maxResults:r,minConfidence:n}=new X(t),a=await C(e),{boxes:i,scores:o}=this.forwardInput(a),s=i[0],c=o[0];for(let e=1;e<i.length;e++)i[e].dispose(),o[e].dispose();let h=Array.from(c.dataSync()),l=Uo(s,h,r,.5,n),d=a.getReshapedInputDimensions(0),u=a.inputSize,p=u/d.width,f=u/d.height,m=s.arraySync(),g=l.map((e=>{let[t,r]=[Math.max(0,m[e][0]),Math.min(1,m[e][2])].map((e=>e*f)),[n,i]=[Math.max(0,m[e][1]),Math.min(1,m[e][3])].map((e=>e*p));return new M(h[e],new Yt(n,t,i-n,r-t),{height:a.getInputHeight(0),width:a.getInputWidth(0)})}));return s.dispose(),c.dispose(),g}getDefaultModelName(){return"ssd_mobilenetv1_model"}extractParamsFromWeightMap(e){return Go(e)}extractParams(e){return Yo(e)}};function qo(e){let t=new St;return t.extractWeights(e),t}function fa(e){return qo(e)}var lo=class extends St{},Zo=.4,Ko=[new g(.738768,.874946),new g(2.42204,2.65704),new g(4.30971,7.04493),new g(10.246,4.59428),new g(12.6868,11.8741)],Qo=[new g(1.603231,2.094468),new g(6.041143,7.080126),new g(2.882459,3.518061),new g(4.266906,5.178857),new g(9.041765,10.66308)],tn=[117.001,114.697,97.404],en="tiny_yolov2_model",rn="tiny_yolov2_separable_conv_model",N=v(x()),Cr=e=>"number"==typeof e;function ho(e){if(!e)throw new Error(`invalid config: ${e}`);if("boolean"!=typeof e.withSeparableConvs)throw new Error(`config.withSeparableConvs has to be a boolean, have: ${e.withSeparableConvs}`);if(!Cr(e.iouThreshold)||e.iouThreshold<0||e.iouThreshold>1)throw new Error(`config.iouThreshold has to be a number between [0, 1], have: ${e.iouThreshold}`);if(!Array.isArray(e.classes)||!e.classes.length||!e.classes.every((e=>"string"==typeof e)))throw new Error(`config.classes has to be an array class names: string[], have: ${JSON.stringify(e.classes)}`);if(!Array.isArray(e.anchors)||!e.anchors.length||!e.anchors.map((e=>e||{})).every((e=>Cr(e.x)&&Cr(e.y))))throw new Error(`config.anchors has to be an array of { x: number, y: number }, have: ${JSON.stringify(e.anchors)}`);if(e.meanRgb&&(!Array.isArray(e.meanRgb)||3!==e.meanRgb.length||!e.meanRgb.every(Cr)))throw new Error(`config.meanRgb has to be an array of shape [number, number, number], have: ${JSON.stringify(e.meanRgb)}`)}var Q=v(x()),K=v(x());function Me(e){return K.tidy((()=>{let t=K.mul(e,K.scalar(.10000000149011612));return K.add(K.relu(K.sub(e,t)),t)}))}function Tt(e,t){return Q.tidy((()=>{let r=Q.pad(e,[[0,0],[1,1],[1,1],[0,0]]);return r=Q.conv2d(r,t.conv.filters,[1,1],"valid"),r=Q.sub(r,t.bn.sub),r=Q.mul(r,t.bn.truediv),r=Q.add(r,t.conv.bias),Me(r)}))}var At=v(x());function wt(e,t){return At.tidy((()=>{let r=At.pad(e,[[0,0],[1,1],[1,1],[0,0]]);return r=At.separableConv2d(r,t.depthwise_filter,t.pointwise_filter,[1,1],"valid"),r=At.add(r,t.bias),Me(r)}))}var bo=v(x());function la(e,t){let r=be(e,t),n=ge(e,t);return{extractConvParams:r,extractConvWithBatchNormParams:function(n,a,i){let o=r(n,a,3,`${i}/conv`),s=function(r,n){let a=bo.tensor1d(e(r)),i=bo.tensor1d(e(r));return t.push({paramPath:`${n}/sub`},{paramPath:`${n}/truediv`}),{sub:a,truediv:i}}(a,`${i}/bn`);return{conv:o,bn:s}},extractSeparableConvParams:n}}function on(e,t,r,n){let a,{extractWeights:i,getRemainingWeights:o}=R(e),s=[],{extractConvParams:c,extractConvWithBatchNormParams:h,extractSeparableConvParams:l}=la(i,s);if(t.withSeparableConvs){let[e,i,o,s,h,d,u,p,f]=n;a={conv0:t.isFirstLayerConv2d?c(e,i,3,"conv0"):l(e,i,"conv0"),conv1:l(i,o,"conv1"),conv2:l(o,s,"conv2"),conv3:l(s,h,"conv3"),conv4:l(h,d,"conv4"),conv5:l(d,u,"conv5"),conv6:p?l(u,p,"conv6"):void 0,conv7:f?l(p,f,"conv7"):void 0,conv8:c(f||p||u,5*r,1,"conv8")}}else{let[e,t,i,o,s,l,d,u,p]=n;a={conv0:h(e,t,"conv0"),conv1:h(t,i,"conv1"),conv2:h(i,o,"conv2"),conv3:h(o,s,"conv3"),conv4:h(s,l,"conv4"),conv5:h(l,d,"conv5"),conv6:h(d,u,"conv6"),conv7:h(u,p,"conv7"),conv8:c(p,5*r,1,"conv8")}}if(0!==o().length)throw new Error(`weights remaing after extract: ${o().length}`);return{params:a,paramMappings:s}}function da(e,t){let r=Y(e,t);function n(e){return{filters:r(`${e}/filters`,4),bias:r(`${e}/bias`,1)}}return{extractConvParams:n,extractConvWithBatchNormParams:function(e){let t=n(`${e}/conv`),a=function(e){return{sub:r(`${e}/sub`,1),truediv:r(`${e}/truediv`,1)}}(`${e}/bn`);return{conv:t,bn:a}},extractSeparableConvParams:xe(r)}}function nn(e,t){let r,n=[],{extractConvParams:a,extractConvWithBatchNormParams:i,extractSeparableConvParams:o}=da(e,n);if(t.withSeparableConvs){let e=t.filterSizes&&t.filterSizes.length||9;r={conv0:t.isFirstLayerConv2d?a("conv0"):o("conv0"),conv1:o("conv1"),conv2:o("conv2"),conv3:o("conv3"),conv4:o("conv4"),conv5:o("conv5"),conv6:e>7?o("conv6"):void 0,conv7:e>8?o("conv7"):void 0,conv8:a("conv8")}}else r={conv0:i("conv0"),conv1:i("conv1"),conv2:i("conv2"),conv3:i("conv3"),conv4:i("conv4"),conv5:i("conv5"),conv6:i("conv6"),conv7:i("conv7"),conv8:a("conv8")};return B(e,n),{params:r,paramMappings:n}}var st=class{constructor({inputSize:e,scoreThreshold:t}={}){if(this._name="TinyYolov2Options",this._inputSize=e||416,this._scoreThreshold=t||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(`${this._name} - expected inputSize to be a number divisible by 32`);if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(`${this._name} - expected scoreThreshold to be a number between 0 and 1`)}get inputSize(){return this._inputSize}get scoreThreshold(){return this._scoreThreshold}},go=class extends A{constructor(e){super("TinyYolov2"),ho(e),this._config=e}get config(){return this._config}get withClassScores(){return this.config.withClassScores||this.config.classes.length>1}get boxEncodingSize(){return 5+(this.withClassScores?this.config.classes.length:0)}runTinyYolov2(e,t){let r=Tt(e,t.conv0);return r=N.maxPool(r,[2,2],[2,2],"same"),r=Tt(r,t.conv1),r=N.maxPool(r,[2,2],[2,2],"same"),r=Tt(r,t.conv2),r=N.maxPool(r,[2,2],[2,2],"same"),r=Tt(r,t.conv3),r=N.maxPool(r,[2,2],[2,2],"same"),r=Tt(r,t.conv4),r=N.maxPool(r,[2,2],[2,2],"same"),r=Tt(r,t.conv5),r=N.maxPool(r,[2,2],[1,1],"same"),r=Tt(r,t.conv6),r=Tt(r,t.conv7),qt(r,t.conv8,"valid",!1)}runMobilenet(e,t){let r=this.config.isFirstLayerConv2d?Me(qt(e,t.conv0,"valid",!1)):wt(e,t.conv0);return r=N.maxPool(r,[2,2],[2,2],"same"),r=wt(r,t.conv1),r=N.maxPool(r,[2,2],[2,2],"same"),r=wt(r,t.conv2),r=N.maxPool(r,[2,2],[2,2],"same"),r=wt(r,t.conv3),r=N.maxPool(r,[2,2],[2,2],"same"),r=wt(r,t.conv4),r=N.maxPool(r,[2,2],[2,2],"same"),r=wt(r,t.conv5),r=N.maxPool(r,[2,2],[1,1],"same"),r=t.conv6?wt(r,t.conv6):r,r=t.conv7?wt(r,t.conv7):r,qt(r,t.conv8,"valid",!1)}forwardInput(e,t){let{params:r}=this;if(!r)throw new Error("TinyYolov2 - load model before inference");return N.tidy((()=>{let n=N.cast(e.toBatchTensor(t,!1),"float32");return n=this.config.meanRgb?rt(n,this.config.meanRgb):n,n=n.div(255),this.config.withSeparableConvs?this.runMobilenet(n,r):this.runTinyYolov2(n,r)}))}async forward(e,t){return this.forwardInput(await C(e),t)}async detect(e,t={}){let{inputSize:r,scoreThreshold:n}=new st(t),a=await C(e),i=await this.forwardInput(a,r),o=N.tidy((()=>N.unstack(i)[0].expandDims())),s={width:a.getInputWidth(0),height:a.getInputHeight(0)},c=await this.extractBoxes(o,a.getReshapedInputDimensions(0),n);i.dispose(),o.dispose();let h=c.map((e=>e.box)),l=c.map((e=>e.score)),d=c.map((e=>e.classScore)),u=c.map((e=>this.config.classes[e.label]));return Yr(h.map((e=>e.rescale(r))),l,this.config.iouThreshold,!0).map((e=>new bt(l[e],d[e],u[e],h[e],s)))}getDefaultModelName(){return""}extractParamsFromWeightMap(e){return nn(e,this.config)}extractParams(e){let t=this.config.filterSizes||go.DEFAULT_FILTER_SIZES,r=t?t.length:void 0;if(7!==r&&8!==r&&9!==r)throw new Error(`TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found ${r} filterSizes in config`);return on(e,this.config,this.boxEncodingSize,t)}async extractBoxes(e,t,r){let{width:n,height:a}=t,i=Math.max(n,a),o=i/n,s=i/a,c=e.shape[1],h=this.config.anchors.length,[l,d,u]=N.tidy((()=>{let t=e.reshape([c,c,h,this.boxEncodingSize]);return[t.slice([0,0,0,0],[c,c,h,4]),t.slice([0,0,0,4],[c,c,h,1]),this.withClassScores?N.softmax(t.slice([0,0,0,5],[c,c,h,this.config.classes.length]),3):N.scalar(0)]})),p=[],f=await d.array(),m=await l.array();for(let e=0;e<c;e++)for(let t=0;t<c;t++)for(let n=0;n<h;n++){let a=Ne(f[e][t][n][0]);if(!r||a>r){let r=(t+Ne(m[e][t][n][0]))/c*o,i=(e+Ne(m[e][t][n][1]))/c*s,h=Math.exp(m[e][t][n][2])*this.config.anchors[n].x/c*o,l=Math.exp(m[e][t][n][3])*this.config.anchors[n].y/c*s,d=r-h/2,f=i-l/2,g={row:e,col:t,anchor:n},{classScore:v,label:w}=this.withClassScores?await this.extractPredictedClass(u,g):{classScore:1,label:0};p.push({box:new Vt(d,f,d+h,f+l),score:a,classScore:a*v,label:w,...g})}}return l.dispose(),d.dispose(),u.dispose(),p}async extractPredictedClass(e,t){let{row:r,col:n,anchor:a}=t,i=await e.array();return Array(this.config.classes.length).fill(0).map(((e,t)=>i[r][n][a][t])).map(((e,t)=>({classScore:e,label:t}))).reduce(((e,t)=>e.classScore>t.classScore?e:t))}},ee=go;ee.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024];var re=class extends ee{constructor(e=!0){super({withSeparableConvs:e,iouThreshold:Zo,classes:["face"],...e?{anchors:Qo,meanRgb:tn}:{anchors:Ko,withClassScores:!0}})}get withSeparableConvs(){return this.config.withSeparableConvs}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map((e=>new M(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})))}getDefaultModelName(){return this.withSeparableConvs?rn:en}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}};function ha(e,t=!0){let r=new re(t);return r.extractWeights(e),r}var je=class extends st{constructor(){super(...arguments),this._name="TinyFaceDetectorOptions"}},J=class{async then(e){return e(await this.run())}async run(){throw new Error("ComposableTask - run is not implemented")}},Xe=v(x()),xo=v(x());async function oe(e,t,r,n,a=(({alignedRect:e})=>e)){let i=e.map((e=>Zt(e)?a(e):e.detection)),o=n||(t instanceof xo.Tensor?await de(t,i):await le(t,i)),s=await r(o);return o.forEach((e=>e instanceof xo.Tensor&&e.dispose())),s}async function Ce(e,t,r,n,a){return oe([e],t,(async e=>r(e[0])),n,a)}var an=.4,sn=[new g(1.603231,2.094468),new g(6.041143,7.080126),new g(2.882459,3.518061),new g(4.266906,5.178857),new g(9.041765,10.66308)],cn=[117.001,114.697,97.404],ne=class extends ee{constructor(){super({withSeparableConvs:!0,iouThreshold:an,classes:["face"],anchors:sn,meanRgb:cn,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map((e=>new M(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})))}getDefaultModelName(){return"tiny_face_detector_model"}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}},P={ssdMobilenetv1:new St,tinyFaceDetector:new ne,tinyYolov2:new re,faceLandmark68Net:new Kt,faceLandmark68TinyNet:new ze,faceRecognitionNet:new Qt,faceExpressionNet:new Oe,ageGenderNet:new He},mn=(e,t)=>P.ssdMobilenetv1.locateFaces(e,t),ba=(e,t)=>P.tinyFaceDetector.locateFaces(e,t),ga=(e,t)=>P.tinyYolov2.locateFaces(e,t),pn=e=>P.faceLandmark68Net.detectLandmarks(e),xa=e=>P.faceLandmark68TinyNet.detectLandmarks(e),va=e=>P.faceRecognitionNet.computeFaceDescriptor(e),ya=e=>P.faceExpressionNet.predictExpressions(e),_a=e=>P.ageGenderNet.predictAgeAndGender(e),un=e=>P.ssdMobilenetv1.load(e),Ta=e=>P.tinyFaceDetector.load(e),wa=e=>P.tinyYolov2.load(e),Pa=e=>P.faceLandmark68Net.load(e),Fa=e=>P.faceLandmark68TinyNet.load(e),Da=e=>P.faceRecognitionNet.load(e),Ea=e=>P.faceExpressionNet.load(e),Ma=e=>P.ageGenderNet.load(e),Ca=un,Ia=mn,Na=pn,Ir=class extends J{constructor(e,t,r){super(),this.parentTask=e,this.input=t,this.extractedFaces=r}},ae=class extends Ir{async run(){let e=await this.parentTask,t=await oe(e,this.input,(async e=>Promise.all(e.map((e=>P.faceExpressionNet.predictExpressions(e))))),this.extractedFaces);return e.map(((e,r)=>xr(e,t[r])))}withAgeAndGender(){return new ie(this,this.input)}},se=class extends Ir{async run(){let e=await this.parentTask;if(e)return xr(e,await Ce(e,this.input,(e=>P.faceExpressionNet.predictExpressions(e)),this.extractedFaces))}withAgeAndGender(){return new ce(this,this.input)}},Wt=class extends ae{withAgeAndGender(){return new Bt(this,this.input)}withFaceDescriptors(){return new Pt(this,this.input)}},kt=class extends se{withAgeAndGender(){return new Rt(this,this.input)}withFaceDescriptor(){return new Ft(this,this.input)}},Nr=class extends J{constructor(e,t,r){super(),this.parentTask=e,this.input=t,this.extractedFaces=r}},ie=class extends Nr{async run(){let e=await this.parentTask,t=await oe(e,this.input,(async e=>Promise.all(e.map((e=>P.ageGenderNet.predictAgeAndGender(e))))),this.extractedFaces);return e.map(((e,r)=>{let{age:n,gender:a,genderProbability:i}=t[r];return Er(Mr(e,a,i),n)}))}withFaceExpressions(){return new ae(this,this.input)}},ce=class extends Nr{async run(){let e=await this.parentTask;if(!e)return;let{age:t,gender:r,genderProbability:n}=await Ce(e,this.input,(e=>P.ageGenderNet.predictAgeAndGender(e)),this.extractedFaces);return Er(Mr(e,r,n),t)}withFaceExpressions(){return new se(this,this.input)}},Bt=class extends ie{withFaceExpressions(){return new Wt(this,this.input)}withFaceDescriptors(){return new Pt(this,this.input)}},Rt=class extends ce{withFaceExpressions(){return new kt(this,this.input)}withFaceDescriptor(){return new Ft(this,this.input)}},Ue=class extends J{constructor(e,t){super(),this.parentTask=e,this.input=t}},Pt=class extends Ue{async run(){let e=await this.parentTask;return(await oe(e,this.input,(e=>Promise.all(e.map((e=>P.faceRecognitionNet.computeFaceDescriptor(e))))),null,(e=>e.landmarks.align(null,{useDlibAlignment:!0})))).map(((t,r)=>Dr(e[r],t)))}withFaceExpressions(){return new Wt(this,this.input)}withAgeAndGender(){return new Bt(this,this.input)}},Ft=class extends Ue{async run(){let e=await this.parentTask;if(e)return Dr(e,await Ce(e,this.input,(e=>P.faceRecognitionNet.computeFaceDescriptor(e)),null,(e=>e.landmarks.align(null,{useDlibAlignment:!0}))))}withFaceExpressions(){return new kt(this,this.input)}withAgeAndGender(){return new Rt(this,this.input)}},Je=class extends J{constructor(e,t,r){super(),this.parentTask=e,this.input=t,this.useTinyLandmarkNet=r}get landmarkNet(){return this.useTinyLandmarkNet?P.faceLandmark68TinyNet:P.faceLandmark68Net}},qe=class extends Je{async run(){let e=await this.parentTask,t=e.map((e=>e.detection)),r=this.input instanceof Xe.Tensor?await de(this.input,t):await le(this.input,t),n=await Promise.all(r.map((e=>this.landmarkNet.detectLandmarks(e))));return r.forEach((e=>e instanceof Xe.Tensor&&e.dispose())),e.filter(((e,t)=>n[t])).map(((e,t)=>Pe(e,n[t])))}withFaceExpressions(){return new Wt(this,this.input)}withAgeAndGender(){return new Bt(this,this.input)}withFaceDescriptors(){return new Pt(this,this.input)}},Ze=class extends Je{async run(){let e=await this.parentTask;if(!e)return;let{detection:t}=e,r=this.input instanceof Xe.Tensor?await de(this.input,[t]):await le(this.input,[t]),n=await this.landmarkNet.detectLandmarks(r[0]);return r.forEach((e=>e instanceof Xe.Tensor&&e.dispose())),Pe(e,n)}withFaceExpressions(){return new kt(this,this.input)}withAgeAndGender(){return new Rt(this,this.input)}withFaceDescriptor(){return new Ft(this,this.input)}},Ke=class extends J{constructor(e,t=new X){super(),this.input=e,this.options=t}},Ie=class extends Ke{async run(){let e,{input:t,options:r}=this;if(r instanceof je)e=P.tinyFaceDetector.locateFaces(t,r);else if(r instanceof X)e=P.ssdMobilenetv1.locateFaces(t,r);else{if(!(r instanceof st))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | TinyYolov2Options");e=P.tinyYolov2.locateFaces(t,r)}return e}runAndExtendWithFaceDetections(){return new Promise(((e,t)=>{this.run().then((t=>e(t.map((e=>jt({},e)))))).catch((e=>t(e)))}))}withFaceLandmarks(e=!1){return new qe(this.runAndExtendWithFaceDetections(),this.input,e)}withFaceExpressions(){return new ae(this.runAndExtendWithFaceDetections(),this.input)}withAgeAndGender(){return new ie(this.runAndExtendWithFaceDetections(),this.input)}},Qe=class extends Ke{async run(){let e=await new Ie(this.input,this.options),t=e[0];return e.forEach((e=>{e.score>t.score&&(t=e)})),t}runAndExtendWithFaceDetection(){return new Promise((async e=>{let t=await this.run();e(t?jt({},t):void 0)}))}withFaceLandmarks(e=!1){return new Ze(this.runAndExtendWithFaceDetection(),this.input,e)}withFaceExpressions(){return new se(this.runAndExtendWithFaceDetection(),this.input)}withAgeAndGender(){return new ce(this.runAndExtendWithFaceDetection(),this.input)}};function Sa(e,t=new X){return new Qe(e,t)}function Sr(e,t=new X){return new Ie(e,t)}async function fn(e,t){return Sr(e,new X(t?{minConfidence:t}:{})).withFaceLandmarks().withFaceDescriptors()}async function La(e,t={}){return Sr(e,new st(t)).withFaceLandmarks().withFaceDescriptors()}var Aa=fn;function vo(e,t){if(e.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");let r=Array.from(e),n=Array.from(t);return Math.sqrt(r.map(((e,t)=>e-n[t])).reduce(((e,t)=>e+t*t),0))}var tr=class{constructor(e,t=.6){this._distanceThreshold=t;let r=Array.isArray(e)?e:[e];if(!r.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");let n=1,a=()=>"person "+n++;this._labeledDescriptors=r.map((e=>{if(e instanceof mt)return e;if(e instanceof Float32Array)return new mt(a(),[e]);if(e.descriptor&&e.descriptor instanceof Float32Array)return new mt(a(),[e.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")}))}get labeledDescriptors(){return this._labeledDescriptors}get distanceThreshold(){return this._distanceThreshold}computeMeanDistance(e,t){return t.map((t=>vo(t,e))).reduce(((e,t)=>e+t),0)/(t.length||1)}matchDescriptor(e){return this.labeledDescriptors.map((({descriptors:t,label:r})=>new pe(r,this.computeMeanDistance(e,t)))).reduce(((e,t)=>e.distance<t.distance?e:t))}findBestMatch(e){let t=this.matchDescriptor(e);return t.distance<this._distanceThreshold?t:new pe("unknown",t.distance)}toJSON(){return{distanceThreshold:this._distanceThreshold,labeledDescriptors:this._labeledDescriptors.map((e=>e.toJSON()))}}static fromJSON(e){let t=e.labeledDescriptors.map((e=>mt.fromJSON(e)));return new tr(t,e.distanceThreshold)}};function Wa(e){let t=new ne;return t.extractWeights(e),t}function ln(e,t){let{width:r,height:n}=new k(t.width,t.height);if(r<=0||n<=0)throw new Error(`resizeResults - invalid dimensions: ${JSON.stringify({width:r,height:n})}`);if(Array.isArray(e))return e.map((e=>ln(e,{width:r,height:n})));if(Zt(e)){let t=e.detection.forSize(r,n),a=e.unshiftedLandmarks.forSize(t.box.width,t.box.height);return Pe(jt(e,t),a)}return pt(e)?jt(e,e.detection.forSize(r,n)):e instanceof z||e instanceof M?e.forSize(r,n):e}var Ba=So;